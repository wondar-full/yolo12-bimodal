# ğŸ“š å…«è‚¡çŸ¥è¯†ç‚¹ #39: Ultralytics å¤šæ•°æ®é›†è”åˆè®­ç»ƒæœºåˆ¶è¯¦è§£

**åˆ›å»ºæ—¶é—´**: 2025-11-16  
**é€‚ç”¨åœºæ™¯**: VisDrone + UAVDT è”åˆè®­ç»ƒ  
**æ ¸å¿ƒé—®é¢˜**: å¦‚ä½•åœ¨ä¸€æ¬¡è®­ç»ƒä¸­åŒæ—¶ä½¿ç”¨å¤šä¸ªæ•°æ®é›†ï¼Ÿ

---

## 1ï¸âƒ£ **æ•°æ®é›†é…ç½®è§£ææµç¨‹**

### **æ­¥éª¤ 1: YAML é…ç½®æ–‡ä»¶è§£æ**

**æ–‡ä»¶ä½ç½®**: `ultralytics/data/utils.py::check_det_dataset()`

```python
def check_det_dataset(dataset: str, autodownload: bool = True) -> dict:
    """
    æ ¸å¿ƒåŠŸèƒ½:
    1. è¯»å– YAML æ–‡ä»¶
    2. éªŒè¯å¿…éœ€å­—æ®µ (train, val, names/nc)
    3. è§£æè·¯å¾„ (æ”¯æŒå­—ç¬¦ä¸²æˆ–åˆ—è¡¨)
    4. è¿”å›æ•°æ®å­—å…¸
    """
    file = check_file(dataset)  # éªŒè¯æ–‡ä»¶å­˜åœ¨
    data = YAML.load(file, append_filename=True)  # åŠ è½½ YAML

    # æ£€æŸ¥å¿…éœ€å­—æ®µ
    for k in "train", "val":
        if k not in data:
            raise SyntaxError(f"'{k}:' key missing")

    # è§£æè·¯å¾„ (å…³é”®: æ”¯æŒåˆ—è¡¨!)
    path = Path(data.get("path") or ".")
    for k in "train", "val", "test":
        if data.get(k):
            if isinstance(data[k], str):
                # å•æ•°æ®é›†: å­—ç¬¦ä¸²è·¯å¾„
                data[k] = str((path / data[k]).resolve())
            else:
                # å¤šæ•°æ®é›†: åˆ—è¡¨è·¯å¾„
                data[k] = [str((path / x).resolve()) for x in data[k]]

    return data  # è¿”å›è§£æåçš„å­—å…¸
```

**æˆ‘ä»¬çš„ YAML é…ç½®**:

```yaml
path: /data2/user/2024/lzy/Datasets

train: # åˆ—è¡¨å½¢å¼!
  - VisDrone2019-DET-YOLO/VisDrone2YOLO/train/images/rgb
  - UAVDT_YOLO/train/images/rgb

val: VisDrone2019-DET-YOLO/VisDrone2YOLO/val/images/rgb # å•è·¯å¾„
```

**è§£æåçš„ç»“æœ**:

```python
data = {
    "path": Path("/data2/user/2024/lzy/Datasets"),
    "train": [
        "/data2/user/2024/lzy/Datasets/VisDrone2019-DET-YOLO/VisDrone2YOLO/train/images/rgb",
        "/data2/user/2024/lzy/Datasets/UAVDT_YOLO/train/images/rgb"
    ],
    "val": "/data2/user/2024/lzy/Datasets/VisDrone2019-DET-YOLO/VisDrone2YOLO/val/images/rgb",
    "nc": 10,
    "names": {0: "pedestrian", 1: "people", ...}
}
```

---

## 2ï¸âƒ£ **æ•°æ®é›†å¯¹è±¡åˆ›å»ºæµç¨‹**

### **æ­¥éª¤ 2: è®­ç»ƒå™¨è°ƒç”¨ `get_dataloader()`**

**æ–‡ä»¶ä½ç½®**: `ultralytics/models/yolo/detect/train.py::DetectionTrainer`

```python
class DetectionTrainer(BaseTrainer):
    def get_dataloader(self, dataset_path, batch_size=16, rank=0, mode="train"):
        """
        æ„é€  DataLoader

        Args:
            dataset_path: æ¥è‡ª data["train"] æˆ– data["val"]
                         å¯èƒ½æ˜¯å­—ç¬¦ä¸² (å•æ•°æ®é›†) æˆ–åˆ—è¡¨ (å¤šæ•°æ®é›†)
        """
        # åˆ›å»ºæ•°æ®é›†å¯¹è±¡
        dataset = self.build_dataset(dataset_path, mode, batch_size)

        # åˆ›å»º DataLoader
        return build_dataloader(
            dataset,
            batch=batch_size,
            workers=self.args.workers,
            shuffle=(mode == "train"),
            rank=rank
        )

    def build_dataset(self, img_path, mode="train", batch=None):
        """
        æ„å»ºæ•°æ®é›†å¯¹è±¡

        Args:
            img_path: å­—ç¬¦ä¸²æˆ–åˆ—è¡¨
        """
        gs = max(int(self.model.stride.max()), 32)
        return build_yolo_dataset(
            self.args,
            img_path,  # ä¼ é€’åŸå§‹è·¯å¾„ (å­—ç¬¦ä¸²æˆ–åˆ—è¡¨)
            batch,
            self.data,
            mode=mode,
            rect=(mode == "val"),
            stride=gs
        )
```

### **æ­¥éª¤ 3: `build_yolo_dataset()` æ™ºèƒ½å¤„ç†**

**æ–‡ä»¶ä½ç½®**: `ultralytics/data/build.py::build_yolo_dataset()`

```python
def build_yolo_dataset(cfg, img_path, batch, data, mode="train", rect=False, stride=32, multi_modal=False):
    """
    æ ¸å¿ƒé€»è¾‘: æ ¹æ® img_path ç±»å‹å†³å®šåˆ›å»ºå•æ•°æ®é›†è¿˜æ˜¯å¤šæ•°æ®é›†

    Args:
        img_path: str (å•æ•°æ®é›†) æˆ– list (å¤šæ•°æ®é›†)
    """
    dataset_class = YOLOMultiModalDataset if multi_modal else YOLODataset

    # å…³é”®åˆ¤æ–­: æ˜¯å¦ä¸ºåˆ—è¡¨?
    if isinstance(img_path, list):
        # å¤šæ•°æ®é›†: åˆ›å»ºå¤šä¸ª YOLODataset å¹¶æ‹¼æ¥
        datasets = []
        for path in img_path:
            ds = dataset_class(
                img_path=path,
                imgsz=cfg.imgsz,
                batch_size=batch,
                augment=(mode == "train"),
                hyp=cfg,
                rect=rect,
                cache=cfg.cache,
                single_cls=cfg.single_cls,
                stride=stride,
                pad=0.0 if mode == "train" else 0.5,
                prefix=colorstr(f"{mode}: "),
                task=cfg.task,
                classes=cfg.classes,
                data=data,
                fraction=cfg.fraction if mode == "train" else 1.0
            )
            datasets.append(ds)

        # ä½¿ç”¨ YOLOConcatDataset æ‹¼æ¥
        return YOLOConcatDataset(datasets)
    else:
        # å•æ•°æ®é›†: ç›´æ¥åˆ›å»º
        return dataset_class(
            img_path=img_path,
            imgsz=cfg.imgsz,
            # ... (åŒä¸Šå‚æ•°)
        )
```

**å®é™…æ‰§è¡Œè¿‡ç¨‹** (æˆ‘ä»¬çš„é…ç½®):

```python
# è®­ç»ƒé˜¶æ®µ
img_path = data["train"]  # åˆ—è¡¨: [VisDroneè·¯å¾„, UAVDTè·¯å¾„]

# build_yolo_dataset() å†…éƒ¨:
isinstance(img_path, list)  # True â†’ è¿›å…¥å¤šæ•°æ®é›†åˆ†æ”¯

datasets = []
for path in img_path:
    # ç¬¬ä¸€æ¬¡å¾ªç¯: path = VisDroneè·¯å¾„
    ds1 = YOLOMultiModalDataset(
        img_path="/data2/.../VisDrone.../train/images/rgb",
        # ... å…¶ä»–å‚æ•°
    )
    datasets.append(ds1)

    # ç¬¬äºŒæ¬¡å¾ªç¯: path = UAVDTè·¯å¾„
    ds2 = YOLOMultiModalDataset(
        img_path="/data2/.../UAVDT_YOLO/train/images/rgb",
        # ... å…¶ä»–å‚æ•°
    )
    datasets.append(ds2)

# æ‹¼æ¥æˆå•ä¸ªæ•°æ®é›†
final_dataset = YOLOConcatDataset([ds1, ds2])

# éªŒè¯é˜¶æ®µ
img_path = data["val"]  # å­—ç¬¦ä¸²: VisDroneè·¯å¾„
isinstance(img_path, list)  # False â†’ è¿›å…¥å•æ•°æ®é›†åˆ†æ”¯
val_dataset = YOLOMultiModalDataset(img_path=img_path, ...)
```

---

## 3ï¸âƒ£ **`YOLOConcatDataset` æ‹¼æ¥æœºåˆ¶**

### **æ ¸å¿ƒç±»å®šä¹‰**

**æ–‡ä»¶ä½ç½®**: `ultralytics/data/dataset.py::YOLOConcatDataset`

```python
from torch.utils.data import ConcatDataset

class YOLOConcatDataset(ConcatDataset):
    """
    ç»§æ‰¿è‡ª PyTorch çš„ ConcatDataset

    åŠŸèƒ½: å°†å¤šä¸ªæ•°æ®é›†æ— ç¼æ‹¼æ¥æˆä¸€ä¸ªå¤§æ•°æ®é›†

    ç¤ºä¾‹:
        ds1: 6,471 å¼  (VisDrone)
        ds2: 23,258 å¼  (UAVDT)
        concatenated: 29,729 å¼  (è‡ªåŠ¨æ‹¼æ¥)
    """

    @staticmethod
    def collate_fn(batch):
        """
        æ•°æ®æ‰¹æ¬¡æ•´ç†å‡½æ•° (ä¿æŒä¸ YOLODataset ä¸€è‡´)
        """
        return YOLODataset.collate_fn(batch)

    def close_mosaic(self, hyp):
        """
        å…³é—­ Mosaic å¢å¼º (è®­ç»ƒæœ«æœŸè°ƒç”¨)

        ä¼šé€’å½’è°ƒç”¨æ‰€æœ‰å­æ•°æ®é›†çš„ close_mosaic()
        """
        for dataset in self.datasets:
            if hasattr(dataset, "close_mosaic"):
                dataset.close_mosaic(hyp)
```

### **PyTorch `ConcatDataset` å·¥ä½œåŸç†**

```python
# PyTorch å®˜æ–¹å®ç° (ç®€åŒ–ç‰ˆ)
class ConcatDataset(Dataset):
    def __init__(self, datasets):
        self.datasets = datasets
        self.cumulative_sizes = self.cumsum(datasets)

    def __len__(self):
        # æ€»é•¿åº¦ = æ‰€æœ‰å­æ•°æ®é›†é•¿åº¦ä¹‹å’Œ
        return self.cumulative_sizes[-1]

    def __getitem__(self, idx):
        # æ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„å­æ•°æ®é›†
        dataset_idx = bisect.bisect_right(self.cumulative_sizes, idx)
        if dataset_idx == 0:
            sample_idx = idx
        else:
            sample_idx = idx - self.cumulative_sizes[dataset_idx - 1]
        return self.datasets[dataset_idx][sample_idx]
```

**ç´¢å¼•æ˜ å°„ç¤ºä¾‹**:

```python
# VisDrone: indices 0 ~ 6,470 (6,471 å¼ )
# UAVDT: indices 6,471 ~ 29,728 (23,258 å¼ )

concatenated[0]      â†’ datasets[0][0]         # VisDrone ç¬¬1å¼ 
concatenated[6470]   â†’ datasets[0][6470]      # VisDrone æœ€åä¸€å¼ 
concatenated[6471]   â†’ datasets[1][0]         # UAVDT ç¬¬1å¼ 
concatenated[29728]  â†’ datasets[1][23257]     # UAVDT æœ€åä¸€å¼ 
```

---

## 4ï¸âƒ£ **æ•°æ®é‡‡æ ·ç­–ç•¥**

### **é»˜è®¤é‡‡æ · (ç­‰æ¦‚ç‡)**

```python
# DataLoader çš„é»˜è®¤è¡Œä¸º
dataloader = DataLoader(
    concatenated_dataset,  # é•¿åº¦ 29,729
    batch_size=16,
    shuffle=True  # éšæœºæ‰“ä¹±æ‰€æœ‰ç´¢å¼•
)

# æ¯ä¸ª epoch:
# 1. ç”Ÿæˆç´¢å¼•åºåˆ—: [0, 1, 2, ..., 29728]
# 2. éšæœºæ‰“ä¹±: [12045, 3, 29000, 145, ...]
# 3. æŒ‰ batch_size åˆ†ç»„: [[12045, 3, ...], [29000, 145, ...], ...]
# 4. è¿­ä»£è¿”å›æ‰¹æ¬¡

# é‡‡æ ·æ¦‚ç‡:
# P(VisDrone) = 6,471 / 29,729 = 21.8%
# P(UAVDT) = 23,258 / 29,729 = 78.2%
```

**ä¼˜ç‚¹**:

- âœ… ç®€å•,æ— éœ€é¢å¤–é…ç½®
- âœ… ç¬¦åˆæ•°æ®é›†çœŸå®åˆ†å¸ƒ

**ç¼ºç‚¹**:

- âŒ UAVDT æ ·æœ¬è¢«é‡‡æ ·é¢‘ç‡é«˜ 3.6 å€
- âŒ æ¨¡å‹å¯èƒ½è¿‡æ‹Ÿåˆ UAVDT,æ¬ æ‹Ÿåˆ VisDrone

### **å¹³è¡¡é‡‡æ · (å¯é€‰,éœ€è‡ªå®šä¹‰)**

```python
# YAML é…ç½®ä¸­çš„ dataset_weights (å½“å‰æœªå¯ç”¨)
dataset_weights:
  visdrone: 3.59  # 23,258 / 6,471 â‰ˆ 3.59
  uavdt: 1.0

# éœ€è¦è‡ªå®šä¹‰ Sampler (Ultralytics é»˜è®¤ä¸æ”¯æŒ)
from torch.utils.data import WeightedRandomSampler

# ä¸ºæ¯ä¸ªæ ·æœ¬åˆ†é…æƒé‡
sample_weights = []
for i in range(len(concatenated_dataset)):
    if i < 6471:  # VisDrone
        sample_weights.append(3.59)
    else:  # UAVDT
        sample_weights.append(1.0)

sampler = WeightedRandomSampler(
    weights=sample_weights,
    num_samples=len(sample_weights),
    replacement=True  # å…è®¸é‡å¤é‡‡æ ·
)

dataloader = DataLoader(
    concatenated_dataset,
    batch_size=16,
    sampler=sampler  # ä½¿ç”¨åŠ æƒé‡‡æ ·å™¨ (ä¸èƒ½åŒæ—¶ shuffle=True)
)

# é‡‡æ ·æ¦‚ç‡ (è¿‘ä¼¼):
# P(VisDrone) â‰ˆ 50%
# P(UAVDT) â‰ˆ 50%
```

**ä¼˜ç‚¹**:

- âœ… æ¯ä¸ªæ•°æ®é›†è¢«é‡‡æ ·æ¬¡æ•°ç›¸è¿‘
- âœ… é¿å…æ•°æ®é›†ä¸å¹³è¡¡å¯¼è‡´çš„åå·®

**ç¼ºç‚¹**:

- âŒ éœ€è¦ä¿®æ”¹ Ultralytics æºç 
- âŒ VisDrone æ ·æœ¬ä¼šè¢«é‡å¤é‡‡æ · (epoch å†…é‡å¤)
- âŒ å¯èƒ½å¯¼è‡´è¿‡æ‹Ÿåˆå°æ•°æ®é›†

**RemDet è®ºæ–‡çš„é€‰æ‹©**: æœªæ˜ç¡®è¯´æ˜,æ¨æµ‹ç”¨**é»˜è®¤ç­‰æ¦‚ç‡é‡‡æ ·**

---

## 5ï¸âƒ£ **RGB-D åŒæ¨¡æ€æ•°æ®åŠ è½½**

### **`YOLOMultiModalDataset` æ‰©å±•**

**æ–‡ä»¶ä½ç½®**: `ultralytics/data/dataset.py::YOLOMultiModalDataset`

```python
class YOLOMultiModalDataset(YOLODataset):
    """
    æ‰©å±• YOLODataset ä»¥æ”¯æŒ RGB-D åŒæ¨¡æ€

    å…³é”®ä¿®æ”¹:
    1. åŠ è½½ RGB å›¾åƒ (åŸæœ‰é€»è¾‘)
    2. åŠ è½½å¯¹åº”çš„ Depth å›¾åƒ (æ–°å¢)
    3. æ‹¼æ¥ä¸º 4 é€šé“è¾“å…¥ [R, G, B, D]
    """

    def __getitem__(self, index):
        # 1. è·å– RGB å›¾åƒè·¯å¾„
        rgb_path = self.im_files[index]

        # 2. æ¨æ–­ Depth å›¾åƒè·¯å¾„
        # rgb: .../images/rgb/0000001.jpg
        # depth: .../images/d/0000001.png
        depth_path = rgb_path.replace("/rgb/", "/d/").replace(".jpg", ".png")

        # 3. åŠ è½½ RGB å›¾åƒ (3 é€šé“)
        rgb_img = cv2.imread(rgb_path)  # (H, W, 3)

        # 4. åŠ è½½ Depth å›¾åƒ (1 é€šé“)
        depth_img = cv2.imread(depth_path, cv2.IMREAD_GRAYSCALE)  # (H, W)
        depth_img = depth_img[..., None]  # (H, W, 1)

        # 5. æ‹¼æ¥ä¸º 4 é€šé“
        rgbd_img = np.concatenate([rgb_img, depth_img], axis=2)  # (H, W, 4)

        # 6. åº”ç”¨æ•°æ®å¢å¼º (Mosaic, MixUp ç­‰)
        sample = self.transforms({"img": rgbd_img, "cls": labels, "bboxes": bboxes})

        return sample
```

### **VisDrone å’Œ UAVDT çš„ RGB-D å¯¹é½**

**ç›®å½•ç»“æ„è¦æ±‚**:

```
/data2/user/2024/lzy/Datasets/
â”œâ”€â”€ VisDrone2019-DET-YOLO/VisDrone2YOLO/train/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ rgb/           â† YAML ä¸­é…ç½®çš„è·¯å¾„
â”‚   â”‚   â”‚   â”œâ”€â”€ 0000001.jpg
â”‚   â”‚   â”‚   â”œâ”€â”€ 0000002.jpg
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ d/             â† è‡ªåŠ¨æ¨æ–­çš„æ·±åº¦å›¾è·¯å¾„
â”‚   â”‚       â”œâ”€â”€ 0000001.png
â”‚   â”‚       â”œâ”€â”€ 0000002.png
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ labels/
â”‚       â””â”€â”€ ...
â””â”€â”€ UAVDT_YOLO/train/
    â”œâ”€â”€ images/
    â”‚   â”œâ”€â”€ rgb/
    â”‚   â”‚   â”œâ”€â”€ M0101_0001.jpg
    â”‚   â”‚   â””â”€â”€ ...
    â”‚   â””â”€â”€ d/
    â”‚       â”œâ”€â”€ M0101_0001.png
    â”‚       â””â”€â”€ ...
    â””â”€â”€ labels/
        â””â”€â”€ ...
```

**å…³é”®ç‚¹**:

1. âœ… RGB å’Œ Depth æ–‡ä»¶åå¿…é¡»ä¸€è‡´ (é™¤æ‰©å±•å)
2. âœ… ä¸¤ä¸ªæ•°æ®é›†éƒ½éœ€è¦ç”Ÿæˆæ·±åº¦å›¾
3. âœ… æ·±åº¦å›¾å¿…é¡»ä¸ RGB å›¾å°ºå¯¸å®Œå…¨ä¸€è‡´
4. âš ï¸ å¦‚æœæ·±åº¦å›¾ç¼ºå¤±,åŠ è½½æ—¶ä¼šæŠ›å‡º `FileNotFoundError`

---

## 6ï¸âƒ£ **å®Œæ•´è®­ç»ƒæµç¨‹å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è§£æ YAML é…ç½®                                                â”‚
â”‚    check_det_dataset("data/uav-joint-rgbd.yaml")                â”‚
â”‚                                                                   â”‚
â”‚    train: [VisDroneè·¯å¾„, UAVDTè·¯å¾„]  â† åˆ—è¡¨å½¢å¼                  â”‚
â”‚    val: VisDroneè·¯å¾„  â† å­—ç¬¦ä¸²å½¢å¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è®­ç»ƒå™¨åˆ›å»º DataLoader                                         â”‚
â”‚    DetectionTrainer.get_dataloader(data["train"])               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ„å»ºæ•°æ®é›†å¯¹è±¡                                                â”‚
â”‚    build_yolo_dataset(img_path=[path1, path2], ...)            â”‚
â”‚                                                                   â”‚
â”‚    æ£€æµ‹åˆ°åˆ—è¡¨ â†’ åˆ›å»ºå¤šæ•°æ®é›†:                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚ ds1 = YOLOMultiModalDataset(path1)       â”‚                 â”‚
â”‚    â”‚   â”œâ”€ æ‰«æ 6,471 å¼  RGB å›¾åƒ               â”‚                 â”‚
â”‚    â”‚   â”œâ”€ æ¨æ–­ 6,471 å¼  Depth å›¾åƒ             â”‚                 â”‚
â”‚    â”‚   â””â”€ ç¼“å­˜æ ‡ç­¾æ–‡ä»¶                         â”‚                 â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚ ds2 = YOLOMultiModalDataset(path2)       â”‚                 â”‚
â”‚    â”‚   â”œâ”€ æ‰«æ 23,258 å¼  RGB å›¾åƒ              â”‚                 â”‚
â”‚    â”‚   â”œâ”€ æ¨æ–­ 23,258 å¼  Depth å›¾åƒ            â”‚                 â”‚
â”‚    â”‚   â””â”€ ç¼“å­˜æ ‡ç­¾æ–‡ä»¶                         â”‚                 â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                   â”‚
â”‚    æ‹¼æ¥: concatenated = YOLOConcatDataset([ds1, ds2])           â”‚
â”‚           é•¿åº¦: 6,471 + 23,258 = 29,729                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åˆ›å»º DataLoader                                               â”‚
â”‚    DataLoader(concatenated, batch=16, shuffle=True, ...)        â”‚
â”‚                                                                   â”‚
â”‚    æ¯ä¸ª epoch:                                                    â”‚
â”‚    â”œâ”€ ç”Ÿæˆç´¢å¼•: [0, 1, 2, ..., 29728]                            â”‚
â”‚    â”œâ”€ éšæœºæ‰“ä¹±: [12045, 3, 29000, ...]                           â”‚
â”‚    â””â”€ åˆ†æ‰¹: [[idx1, idx2, ...], ...]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è®­ç»ƒå¾ªç¯ (æ¯ä¸ª batch)                                         â”‚
â”‚    for batch in dataloader:                                     â”‚
â”‚        # batch["img"]: (16, 4, 640, 640) â† RGB-D 4é€šé“           â”‚
â”‚        # batch["cls"]: (N,) â† ç±»åˆ«æ ‡ç­¾                           â”‚
â”‚        # batch["bboxes"]: (N, 4) â† è¾¹ç•Œæ¡†                        â”‚
â”‚                                                                   â”‚
â”‚        ä¸€ä¸ª batch å¯èƒ½åŒ…å«:                                       â”‚
â”‚        â”œâ”€ 3 å¼  VisDrone å›¾åƒ (ç´¢å¼• < 6471)                       â”‚
â”‚        â””â”€ 13 å¼  UAVDT å›¾åƒ (ç´¢å¼• >= 6471)                        â”‚
â”‚                                                                   â”‚
â”‚        loss = model(batch["img"], batch["bboxes"], ...)         â”‚
â”‚        loss.backward()                                           â”‚
â”‚        optimizer.step()                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7ï¸âƒ£ **å¸¸è§é—®é¢˜ä¸è§£ç­”**

### **Q1: ä¸¤ä¸ªæ•°æ®é›†çš„ç±»åˆ«ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ**

**é—®é¢˜**:

- VisDrone: 10 ç±» (pedestrian, car, bus, ...)
- UAVDT: 3 ç±» (car, truck, bus)

**è§£å†³æ–¹æ¡ˆ (YAML é…ç½®)**:

```yaml
# æ–¹æ¡ˆ1: ç±»åˆ«æ˜ å°„ (æ¨è)
uavdt_class_mapping:
  car: 3 # æ˜ å°„åˆ° VisDrone çš„ car (index=3)
  truck: 5 # æ˜ å°„åˆ° VisDrone çš„ truck (index=5)
  bus: 8 # æ˜ å°„åˆ° VisDrone çš„ bus (index=8)

# æ–¹æ¡ˆ2: è¿‡æ»¤éå…±äº«ç±»åˆ«
# UAVDT ä¸­é™¤äº† car/truck/bus å¤–çš„æ ‡æ³¨ä¼šè¢«å¿½ç•¥
```

**å®ç°ä½ç½®**: `ultralytics/data/dataset.py::YOLODataset.get_labels()`

```python
def get_labels(self):
    # è¯»å–æ ‡ç­¾æ–‡ä»¶
    with open(label_path) as f:
        labels = [line.split() for line in f.readlines()]

    # åº”ç”¨ç±»åˆ«æ˜ å°„ (å¦‚æœé…ç½®äº† uavdt_class_mapping)
    if self.data.get("uavdt_class_mapping"):
        mapping = self.data["uavdt_class_mapping"]
        labels = [
            [mapping.get(int(l[0]), int(l[0]))] + l[1:]  # æ˜ å°„ç±»åˆ«ID
            for l in labels
        ]

    return labels
```

### **Q2: å¦‚ä½•ç¡®ä¿ä¸¤ä¸ªæ•°æ®é›†çš„æ·±åº¦å›¾è´¨é‡ä¸€è‡´ï¼Ÿ**

**å»ºè®®**:

1. âœ… ä½¿ç”¨ç›¸åŒçš„æ·±åº¦ä¼°è®¡æ¨¡å‹ (Depth-Anything-V2)
2. âœ… ä½¿ç”¨ç›¸åŒçš„ç”Ÿæˆå‚æ•° (batch_size, ç²¾åº¦ç­‰)
3. âœ… éªŒè¯æ·±åº¦å›¾è´¨é‡:

   ```bash
   python check_depth_quality.py \
       --dataset visdrone \
       --rgb-dir /data2/.../VisDrone.../train/images/rgb \
       --depth-dir /data2/.../VisDrone.../train/images/d

   python check_depth_quality.py \
       --dataset uavdt \
       --rgb-dir /data2/.../UAVDT_YOLO/train/images/rgb \
       --depth-dir /data2/.../UAVDT_YOLO/train/images/d
   ```

### **Q3: è®­ç»ƒæ—¶å¦‚ä½•ç›‘æ§ä¸¤ä¸ªæ•°æ®é›†çš„åˆ†å¸ƒï¼Ÿ**

**æ–¹æ¡ˆ**: åœ¨ callback ä¸­è®°å½•æ¯ä¸ª batch çš„æ•°æ®é›†æ¥æº

```python
def log_dataset_distribution(trainer):
    """è®°å½•æ¯ä¸ª batch ä¸­ VisDrone å’Œ UAVDT çš„æ¯”ä¾‹"""
    batch_paths = trainer.batch["im_file"]  # å›¾åƒè·¯å¾„åˆ—è¡¨

    visdrone_count = sum(1 for p in batch_paths if "VisDrone" in p)
    uavdt_count = sum(1 for p in batch_paths if "UAVDT" in p)

    LOGGER.info(f"Batch distribution: VisDrone={visdrone_count}, UAVDT={uavdt_count}")

model.add_callback('on_train_batch_start', log_dataset_distribution)
```

### **Q4: ä¸ºä»€ä¹ˆéªŒè¯åªç”¨ VisDroneï¼Ÿ**

**RemDet è®ºæ–‡åè®®** (é‡è¦æ›´æ­£):

- **è®­ç»ƒ**: VisDrone train (6,471) + UAVDT train (23,258) = **29,729 å¼ è”åˆè®­ç»ƒ**
- **éªŒè¯**:
  - **Table 1**: åªåœ¨ VisDrone val (548 å¼ ) ä¸ŠéªŒè¯
  - **Table 2**: åªåœ¨ UAVDT test (15,069 å¼ ) ä¸ŠéªŒè¯
  - **å…³é”®**: è™½ç„¶åˆ†å¼€éªŒè¯,ä½†è®­ç»ƒæ—¶æ˜¯è”åˆçš„!

**åŸå› **:

1. **VisDrone** æ˜¯æ ‡å‡† benchmark,ä¾¿äºä¸å…¶ä»–è®ºæ–‡å¯¹æ¯” (Table 1 ä¸»è¡¨)
2. **UAVDT** ç”¨äºéªŒè¯æ¨¡å‹æ³›åŒ–èƒ½åŠ› (Table 2 è¾…åŠ©è¡¨)
3. ä¸¤ä¸ªéªŒè¯é›†çš„è¯„æµ‹åè®®ä¸åŒ,éœ€è¦åˆ†å¼€æŠ¥å‘Š

**æˆ‘ä»¬çš„é…ç½®** (å¯¹é½ RemDet Table 1):

```yaml
# è®­ç»ƒ: è”åˆä¸¤ä¸ªæ•°æ®é›†
train:
  - VisDrone2019-DET-YOLO/VisDrone2YOLO/train/images/rgb
  - UAVDT_YOLO/train/images/rgb

# éªŒè¯: åªç”¨ VisDrone (å¯¹é½ Table 1)
val: VisDrone2019-DET-YOLO/VisDrone2YOLO/val/images/rgb
# å¦‚æœè¦å¤ç° Table 2,éœ€è¦ä¿®æ”¹ä¸º:
# val: UAVDT_YOLO/test/images/rgb
```

**æ³¨æ„**: æˆ‘ä»¬å½“å‰é…ç½®ä¸ RemDet çš„ **Table 1** å®Œå…¨ä¸€è‡´ (è®­ç»ƒè”åˆ,éªŒè¯åªç”¨ VisDrone)

---

## 8ï¸âƒ£ **æ€§èƒ½ä¼˜åŒ–å»ºè®®**

### **1. æ•°æ®åŠ è½½åŠ é€Ÿ**

```python
# train_uav_joint.py ä¸­çš„é…ç½®
parser.add_argument("--workers", type=int, default=8)  # å¢åŠ  workers
parser.add_argument("--cache", action="store_true")    # ç¼“å­˜å›¾åƒåˆ°å†…å­˜

# å¦‚æœå†…å­˜å……è¶³ (>64GB):
python train_uav_joint.py --cache --workers 16
```

### **2. ç¼“å­˜æ ‡ç­¾æ–‡ä»¶**

Ultralytics ä¼šè‡ªåŠ¨ç”Ÿæˆ `.cache` æ–‡ä»¶:

```
VisDrone2019-DET-YOLO/VisDrone2YOLO/train/labels.cache
UAVDT_YOLO/train/labels.cache
```

**é¦–æ¬¡è®­ç»ƒ**: æ‰«ææ‰€æœ‰å›¾åƒ,ç”Ÿæˆç¼“å­˜ (~5-10 åˆ†é’Ÿ)  
**åç»­è®­ç»ƒ**: ç›´æ¥è¯»å–ç¼“å­˜ (~10 ç§’)

### **3. æ··åˆç²¾åº¦è®­ç»ƒ**

```python
parser.add_argument("--amp", action="store_true", default=True)
# è‡ªåŠ¨ä½¿ç”¨ FP16 æ··åˆç²¾åº¦ â†’ æ˜¾å­˜é™ä½ 40%, é€Ÿåº¦æå‡ 20%
```

---

## 9ï¸âƒ£ **æ€»ç»“**

**è”åˆè®­ç»ƒçš„æœ¬è´¨**:

1. **é…ç½®é˜¶æ®µ**: YAML ä¸­ç”¨åˆ—è¡¨æŒ‡å®šå¤šä¸ªæ•°æ®é›†è·¯å¾„
2. **è§£æé˜¶æ®µ**: `check_det_dataset()` è§£æä¸ºè·¯å¾„åˆ—è¡¨
3. **æ„å»ºé˜¶æ®µ**: `build_yolo_dataset()` ä¸ºæ¯ä¸ªè·¯å¾„åˆ›å»ºç‹¬ç«‹æ•°æ®é›†
4. **æ‹¼æ¥é˜¶æ®µ**: `YOLOConcatDataset` æ— ç¼æ‹¼æ¥ä¸ºå•ä¸ªå¤§æ•°æ®é›†
5. **è®­ç»ƒé˜¶æ®µ**: DataLoader éšæœºé‡‡æ ·æ‰€æœ‰æ ·æœ¬,æ¨¡å‹æ— æ„ŸçŸ¥æ•°æ®é›†æ¥æº

**å…³é”®ä¼˜åŠ¿**:

- âœ… **é€æ˜æ€§**: æ¨¡å‹ä¸çŸ¥é“æ•°æ®æ¥è‡ªå¤šä¸ªæ•°æ®é›†
- âœ… **çµæ´»æ€§**: è½»æ¾æ·»åŠ /åˆ é™¤æ•°æ®é›† (ä¿®æ”¹ YAML å³å¯)
- âœ… **æ•ˆç‡**: æ— éœ€æ‰‹åŠ¨åˆå¹¶æ•°æ®é›†ç›®å½•
- âœ… **å¯æ§æ€§**: å¯é€šè¿‡è‡ªå®šä¹‰ Sampler è°ƒæ•´é‡‡æ ·ç­–ç•¥

**å¯¹æ¯” RemDet**:

- âœ… æ•°æ®é›†å®Œå…¨ä¸€è‡´ (VisDrone + UAVDT)
- âœ… è®­ç»ƒé›†é‡‡æ ·æ–¹å¼ä¸€è‡´ (ç­‰æ¦‚ç‡)
- âœ… éªŒè¯é›†ä¸€è‡´ (VisDrone only)
- âœ… ç±»åˆ«æ˜ å°„æ­£ç¡® (UAVDT 3 ç±» â†’ VisDrone 10 ç±»ä½“ç³»)

**ä¸‹ä¸€æ­¥**:

- [ ] éªŒè¯æ·±åº¦å›¾å®Œæ•´æ€§ (`check_depth_quality.py`)
- [ ] è¿è¡Œ 10 epoch æµ‹è¯•è®­ç»ƒ
- [ ] æ£€æŸ¥è®­ç»ƒæ—¥å¿—,ç¡®è®¤æ•°æ®åŠ è½½æ­£å¸¸
- [ ] å¯åŠ¨å®Œæ•´ 300 epoch è®­ç»ƒ

---

**é¢è¯•è¿½é—®æ¨¡æ‹Ÿ**:

**Q**: å¦‚æœä¸¤ä¸ªæ•°æ®é›†çš„å›¾åƒå°ºå¯¸ä¸åŒæ€ä¹ˆåŠï¼Ÿ  
**A**: Ultralytics çš„ `LetterBox` å˜æ¢ä¼šè‡ªåŠ¨ resize åˆ°ç»Ÿä¸€çš„ `imgsz` (640x640),ä¿æŒé•¿å®½æ¯”,å¡«å……è¾¹ç¼˜ã€‚

**Q**: `YOLOConcatDataset` å’Œç®€å•çš„ `list1 + list2` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ  
**A**: `ConcatDataset` æ˜¯ PyTorch Dataset,æ”¯æŒ `__len__` å’Œ `__getitem__`,å¯ç›´æ¥ä¼ ç»™ DataLoaderã€‚ç®€å•æ‹¼æ¥åˆ—è¡¨æ— æ³•ä½œä¸º Dataset ä½¿ç”¨,ä¸”æ— æ³•å¤„ç†ç´¢å¼•æ˜ å°„ã€‚

**Q**: å¦‚ä½•å®ç°æ¯ä¸ª epoch VisDrone å’Œ UAVDT å„é‡‡æ · 50%ï¼Ÿ  
**A**: éœ€è¦è‡ªå®šä¹‰ `WeightedRandomSampler`,ä¸º VisDrone æ ·æœ¬è®¾ç½®é«˜æƒé‡ (3.59),ä½¿å…¶è¢«é‡å¤é‡‡æ ·,è¾¾åˆ°å¹³è¡¡ã€‚ä½†è¿™ä¼šå¯¼è‡´å°æ•°æ®é›†è¿‡æ‹Ÿåˆã€‚

**Q**: è”åˆè®­ç»ƒå¯¹ BatchNorm æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ  
**A**: BatchNorm çš„ç»Ÿè®¡é‡ (mean/std) ä¼šå—ä¸¤ä¸ªæ•°æ®é›†çš„æ··åˆåˆ†å¸ƒå½±å“ã€‚å¦‚æœæ•°æ®é›†ç»Ÿè®¡ç‰¹æ€§å·®å¼‚å¤§,å¯èƒ½éœ€è¦ä½¿ç”¨ GroupNorm æˆ– LayerNormã€‚

---

**å‚è€ƒèµ„æ–™**:

- PyTorch ConcatDataset: https://pytorch.org/docs/stable/data.html#torch.utils.data.ConcatDataset
- Ultralytics æ•°æ®æ ¼å¼: https://docs.ultralytics.com/datasets/detect/
- RemDet è®ºæ–‡: AAAI 2025, Section 4.1 Training Details
