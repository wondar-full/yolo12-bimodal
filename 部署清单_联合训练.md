# VisDrone + UAVDT 联合训练部署清单

**创建日期**: 2025-11-16  
**目标**: 对齐 RemDet 论文训练协议,实现 RGB-D 双模态联合训练  
**数据集**: VisDrone (6,471) + UAVDT (23,258) = 29,729 训练图像  
**目标指标**: 超越 RemDet-X 45.2% mAP@0.5

---

## 📁 已创建文件清单

### 1. 数据集配置文件

| 文件路径                   | 说明                        | 状态      |
| -------------------------- | --------------------------- | --------- |
| `data/uav-joint-rgbd.yaml` | VisDrone+UAVDT 联合训练配置 | ✅ 已创建 |
| `data/coco2014-rgbd.yaml`  | COCO 预训练配置(可选)       | ✅ 已创建 |

**data/uav-joint-rgbd.yaml 关键内容**:

- VisDrone 路径: `/data2/user/2024/lzy/Datasets/VisDrone2019-DET-YOLO/VisDrone2YOLO/`
- UAVDT 路径: `/data2/user/2024/lzy/Datasets/UAVDT_YOLO/`
- 10 类 VisDrone 标签 + UAVDT 3 类映射
- RGB-D 对齐路径配置

### 2. 模型配置文件

| 文件路径                                                 | 说明                    | 状态      |
| -------------------------------------------------------- | ----------------------- | --------- |
| `ultralytics/cfg/models/12/yolo12s-rgbd-v2.1-joint.yaml` | RGB-D v2.1 联合训练模型 | ✅ 已创建 |

**架构说明**:

- 与 `yolo12s-rgbd-v2.1.yaml` 完全一致
- RGBDStem 早期融合 (Layer 0)
- RGBDMidFusion 多尺度融合 (Layers 5, 8, 11 @ P3/P4/P5)
- 无架构改动,仅更新元数据和注释

### 3. 训练脚本

| 文件路径             | 说明                        | 状态      |
| -------------------- | --------------------------- | --------- |
| `train_uav_joint.py` | VisDrone+UAVDT 联合训练脚本 | ✅ 已创建 |

**关键特性**:

- RemDet 对齐参数: SGD, lr=0.01, momentum=0.937, weight_decay=0.0005
- From scratch 训练(无 COCO 预训练)
- 300 epochs, Mosaic=1.0, MixUp=0.15
- TAL topk warmup (前 20 epochs topk=12)
- Loss gain scheduling (40-80 epochs 逐步提升 box/dfl gain)
- 详细监控日志 (rgbd_joint_monitor.csv)
- 完整八股知识点注释

**使用示例**:

```bash
# 快速测试(10 epochs)
python train_uav_joint.py --device 0 --batch 8 --epochs 10 --name test_joint

# 完整训练(300 epochs)
python train_uav_joint.py --device 0 --batch 16 --epochs 300 --name rgbd_v2.1_joint_300ep
```

### 4. 验证脚本

| 文件路径           | 说明                | 状态      |
| ------------------ | ------------------- | --------- |
| `val_uav_joint.py` | RemDet 对齐验证脚本 | ✅ 已创建 |

**关键特性**:

- 仅在 VisDrone val set 验证(RemDet 协议)
- 对比 RemDet-X、RGB-D v2.1、RGB-only 三个基线
- COCO-style metrics (mAP@0.5, mAP@0.5:0.95, AP_small 等)
- 自动判断是否超越 RemDet-X
- 导出 val_summary.json 便于后续分析

**使用示例**:

```bash
python val_uav_joint.py \
    --weights runs/train/rgbd_v2.1_joint_300ep/weights/best.pt \
    --data data/uav-joint-rgbd.yaml \
    --device 0 \
    --batch 16
```

### 5. 辅助工具

| 文件路径                 | 说明                 | 状态      |
| ------------------------ | -------------------- | --------- |
| `check_dataset_ready.py` | 数据集完整性检查脚本 | ✅ 已创建 |

**检查项目**:

- 目录结构是否完整
- RGB/Depth/Label 文件数量对齐
- YAML 配置正确性
- 样本文件可读性

**使用方法**:

```bash
# 在远程服务器运行
cd /data2/user/2024/lzy/
python yoloDepth/check_dataset_ready.py
```

---

## 🔧 部署步骤

### Phase 1: 准备阶段 (本地)

**已完成**:

- [x] 创建所有配置文件和脚本
- [x] 编写完整八股知识点注释
- [x] 添加详细使用说明

### Phase 2: 数据验证 (远程服务器)

**待执行**:

1. 上传所有文件到远程服务器

   ```bash
   # 本地Windows PowerShell
   scp -r yoloDepth/ user@server:/data2/user/2024/lzy/
   ```

2. 运行数据集检查脚本

   ```bash
   # 远程服务器
   cd /data2/user/2024/lzy/
   python yoloDepth/check_dataset_ready.py
   ```

3. 检查深度图质量(可选)
   ```bash
   cd yoloDepth
   python check_depth_quality.py \
       --dataset /data2/user/2024/lzy/Datasets/VisDrone2019-DET-YOLO/VisDrone2YOLO \
       --split train \
       --num_samples 100
   ```

### Phase 3: 快速测试 (10 epochs)

**目的**: 验证代码无错误、数据加载正常、RGB-D 融合工作

```bash
cd /data2/user/2024/lzy/yoloDepth
python train_uav_joint.py \
    --device 0 \
    --batch 8 \
    --epochs 10 \
    --name test_joint_10ep \
    --workers 4
```

**预期输出**:

- 无错误退出
- `runs/train/test_joint_10ep/` 目录生成
- `metrics/rgbd_joint_monitor.csv` 包含 10 行记录
- gate_mean 在 0.2-0.6 范围(融合权重正常)
- loss 逐步下降(无 NaN/Inf)

**检查命令**:

```bash
# 查看监控日志
tail -n 20 runs/train/test_joint_10ep/metrics/rgbd_joint_monitor.csv

# 查看训练曲线
tensorboard --logdir runs/train/test_joint_10ep --port 6006
```

### Phase 4: 完整训练 (300 epochs)

**确认测试成功后启动**:

```bash
python train_uav_joint.py \
    --device 0 \
    --batch 16 \
    --epochs 300 \
    --name rgbd_v2.1_joint_300ep \
    --workers 8 \
    --save_period 50 \
    --patience 100
```

**训练参数说明**:

- `--batch 16`: 单卡最大 batch (RTX 4090 24GB)
- `--workers 8`: 数据加载线程数
- `--save_period 50`: 每 50 epochs 保存 checkpoint
- `--patience 100`: Early stopping 耐心值(建议不启用,训练满 300 epochs)

**预计耗时**: 5-6 天 (单卡 RTX 4090)

**监控要点**:

1. **每日检查** (epoch 1-100):

   - loss 是否稳定下降
   - gate_mean 是否在 0.3-0.5 区间
   - fg_ratio 是否在 0.05-0.15 区间

2. **每 3 天检查** (epoch 100-300):

   - mAP@0.5是否持续提升
   - 是否出现过拟合(train mAP >> val mAP)
   - box_gain/dfl_gain 是否按计划增长

3. **异常情况处理**:
   - Loss 突然 NaN → 降低学习率,检查数据质量
   - gate_mean=0 或 1 → 融合失败,检查 depth 质量
   - mAP@50 epoch 仍<30% → 数据加载有问题

### Phase 5: 验证与对比

**训练完成后运行**:

```bash
# 验证best.pt
python val_uav_joint.py \
    --weights runs/train/rgbd_v2.1_joint_300ep/weights/best.pt \
    --data data/uav-joint-rgbd.yaml \
    --device 0 \
    --batch 16

# 验证last.pt(可选)
python val_uav_joint.py \
    --weights runs/train/rgbd_v2.1_joint_300ep/weights/last.pt \
    --data data/uav-joint-rgbd.yaml \
    --device 0 \
    --batch 16
```

**成功标准**:

- ✅ **主指标**: mAP@0.5 > 45.2% (RemDet-X)
- ✅ **次要指标**: AP_small > 19.5% (RemDet-X)
- ✅ **速度**: 推理延迟 < 10ms (RTX 4090)

**查看结果**:

```bash
# 验证摘要
cat runs/val/visdrone_joint_val/metrics/val_summary.json

# 详细指标
cat runs/val/visdrone_joint_val/metrics/metrics_latest.json
```

---

## 📊 预期性能对比

| 方法                 | 数据集         | mAP@0.5       | mAP@0.5:0.95 | AP_small   | 训练 epochs |
| -------------------- | -------------- | ------------- | ------------ | ---------- | ----------- |
| RGB-only             | VisDrone       | 40.4%         | 24.1%        | 14.2%      | 238         |
| RGB-D v2.1           | VisDrone       | 43.5%         | 26.3%        | 16.1%      | 244         |
| RemDet-X             | VisDrone+UAVDT | **45.2%**     | 29.9%        | 19.5%      | 300         |
| **RGB-D v2.1 Joint** | VisDrone+UAVDT | **46-47%** ✨ | **28-29%**   | **20-21%** | 300         |

**改进来源分析**:

1. **RGB-D 融合**: +3% mAP@0.5 (已在 v2.1 验证)
2. **数据集扩充**: +1.5-2% (VisDrone 6K → 30K)
3. **总增益**: 40.4% → 46-47% (+5.5-6.5%)

---

## ⚠️ 常见问题与解决方案

### 1. 数据集路径错误

**症状**: `FileNotFoundError: /data2/user/2024/lzy/Datasets/...`

**解决**:

```bash
# 检查实际路径
ls -la /data2/user/2024/lzy/Datasets/

# 修改data/uav-joint-rgbd.yaml中的path字段
```

### 2. UAVDT 类别映射错误

**症状**: 训练时出现`KeyError: 0` 或类别数不匹配

**解决**: 确认 UAVDT labels 已转换为 VisDrone 格式

- UAVDT 原始: car=0, truck=1, bus=2
- 转换后: car=3, truck=5, bus=8 (VisDrone IDs)

### 3. 深度图缺失

**症状**: `DepthFileNotFound: xxx.png`

**解决**:

```bash
# 方案1: 生成缺失的深度图
python generate_depth_maps.py --missing_only

# 方案2: 使用零深度fallback (训练时自动处理)
# 无需修改,代码已包含容错机制
```

### 4. OOM (Out of Memory)

**症状**: `CUDA out of memory`

**解决**:

```bash
# 降低batch size
python train_uav_joint.py --batch 8  # instead of 16

# 或启用gradient accumulation (保持effective batch=128)
# 代码已自动处理: nbs=128, accumulate=128/batch
```

### 5. 训练速度慢

**症状**: 每个 epoch > 2 小时

**优化**:

```bash
# 增加workers
python train_uav_joint.py --workers 12

# 启用图像缓存 (需要足够RAM)
python train_uav_joint.py --cache ram

# 使用更小的imgsz (牺牲精度)
python train_uav_joint.py --imgsz 512
```

---

## 📚 八股知识点索引

本次创建的脚本包含以下八股知识点,建议学习:

### train_uav_joint.py

1. 多数据集联合训练策略 (Q1-Q7)
2. From scratch vs 预训练的选择 (Q3)
3. 梯度累积与 batch size 的关系 (Q2)
4. 余弦学习率调度器 (Q4)
5. Mosaic/MixUp 数据增强 (Q5, Q6)
6. Early stopping 策略 (Q7)

### val_uav_joint.py

1. mAP@0.5 vs mAP@0.5:0.95 (Q1)
2. AP_small/medium/large 划分 (Q2)
3. 置信度阈值选择 (Q3)
4. 验证集选择原则 (Q4)
5. FP16 推理精度影响 (Q5)
6. COCO 格式预测导出 (Q6)

### yolo12s-rgbd-v2.1-joint.yaml

1. v2.1 架构设计原理 (文件末尾)
2. 多尺度融合层级选择
3. Depth skip connection 机制
4. fusion_weight 可学习参数
5. FLOPs 增量计算

---

## 🎯 下一步计划

### 短期 (1-2 周):

1. 执行 Phase 2-3 (数据验证 + 10 epoch 测试)
2. 确认无错误后启动 Phase 4 (300 epoch 完整训练)
3. 每日监控训练指标

### 中期 (2-4 周):

1. 训练完成后执行 Phase 5 (验证与对比)
2. 分析是否超越 RemDet-X
3. 撰写改进记录.md 总结

### 长期 (1-2 月):

1. 如果超越 RemDet-X → 准备论文投稿
2. 如果未超越 → 分析瓶颈,考虑:
   - SOLR 损失加权
   - ChannelC2f 模块
   - COCO 预训练 ablation study
   - 更长训练 (400-500 epochs)

---

## 📝 文档维护

**本清单最后更新**: 2025-11-16  
**责任人**: AI 导师  
**下次更新时机**: Phase 3 测试完成后,记录实际遇到的问题

**需要记录的内容**:

- 实际训练耗时
- 遇到的错误及解决方法
- 最终性能指标
- 与预期的差异分析

---

**🚀 祝训练顺利!如有任何问题,随时查阅本清单或咨询导师。**
