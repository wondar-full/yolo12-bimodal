# Ultralytics YOLO ğŸš€, AGPL-3.0 license
# YOLO12 RGB-D + GGFE Universal Config (æ”¯æŒ n/s/m/l/x æ‰€æœ‰å°ºå¯¸)
# Created: 2025-01-20
# Goal: é€šè¿‡GGFEå‡ ä½•å¼•å¯¼å¢å¼ºï¼Œè¶…è¶ŠRemDetæ€§èƒ½

# ================================================================================================
# ä½¿ç”¨è¯´æ˜
# ================================================================================================
# è®­ç»ƒå‘½ä»¤ (ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´):
#
# YOLOv12-N + GGFE (å¯¹æ ‡RemDet-Tiny):
#   python train_depth_solr_v2.py \
#       --name visdrone_ggfe_n \
#       --data /path/to/visdrone-rgbd.yaml \
#       --device 4 \
#       --weights /path/to/yolo12n.pt \
#       --cfg n \
#       --medium_weight 2.5 \
#       --batch 16 \
#       --epochs 300
#
# å¿«é€ŸéªŒè¯ (100 epochs):
#   python train_depth_solr_v2.py \
#       --name visdrone_ggfe_n_100ep \
#       --data /path/to/visdrone-rgbd.yaml \
#       --device 4 \
#       --weights /path/to/yolo12n.pt \
#       --cfg n \
#       --medium_weight 2.5 \
#       --batch 16 \
#       --epochs 100

# ================================================================================================
# Model Configuration
# ================================================================================================
nc: 10 # Number of classes (VisDrone)

# Model compound scaling constants
# [depth_multiple, width_multiple, max_channels]
scales:
  n: [0.50, 0.25, 1024] # nano   - è½»é‡çº§ (~3.5M params, å¯¹æ ‡RemDet-Tiny)
  s: [0.50, 0.50, 1024] # small  - æ ‡å‡†   (~11.5M params, å¯¹æ ‡RemDet-S)
  m: [0.50, 1.00, 512] # medium - ä¸­å‹   (~22.5M params, å¯¹æ ‡RemDet-M)
  l: [1.00, 1.00, 512] # large  - å¤§å‹   (~44.5M params, å¯¹æ ‡RemDet-L)
  x: [1.00, 1.50, 512] # xlarge - è¶…å¤§   (~66.5M params, å¯¹æ ‡RemDet-X)

# ================================================================================================
# Backbone (Feature Extractor) - RGB-D Fusion with GGFE Enhancement
# ================================================================================================
backbone:
  # [from, repeats, module, args]

  # ============ P1/2 Stage - Early Fusion ============
  - [-1, 1, RGBDStem, [4, 128, 3, 2, 1, 64, "gated_add", 16, True]] # 0-P1/2

  # ============ P2/4 Stage ============
  - [-1, 1, Conv, [128, 3, 2]] # 1-P2/4
  - [-1, 2, C3k2, [256, False, 0.25]] # 2

  # ============ P3/8 Stage - GGFE Enhanced Depth Fusion ============
  - [-1, 1, Conv, [256, 3, 2]] # 3-P3/8
  - [-1, 2, C3k2, [512, False, 0.25]] # 4-P3 features
  - [[4, 0], 1, RGBDGGFEFusion, [512, 64, 16, 0.3, True, 8]] # 5-P3 RGBD+GGFE âœ¨
  #                            å‚æ•°è¯´æ˜: [rgb_ch, depth_ch, reduction, fusion_weight, use_ggfe, ggfe_reduction]

  # ============ P4/16 Stage - GGFE Enhanced Depth Fusion ============
  - [-1, 1, Conv, [512, 3, 2]] # 6-P4/16
  - [-1, 4, A2C2f, [512, True, 4]] # 7-P4 features
  - [[7, 0], 1, RGBDGGFEFusion, [512, 64, 16, 0.3, True, 8]] # 8-P4 RGBD+GGFE âœ¨

  # ============ P5/32 Stage - GGFE Enhanced Depth Fusion ============
  - [-1, 1, Conv, [1024, 3, 2]] # 9-P5/32
  - [-1, 4, A2C2f, [1024, True, 1]] # 10-P5 features
  - [[10, 0], 1, RGBDGGFEFusion, [1024, 64, 16, 0.3, True, 8]] # 11-P5 RGBD+GGFE âœ¨
b
# ================================================================================================
# Head (Detection) - Standard YOLOv12
# ================================================================================================
head:
  # ============ Upsample Path ============
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]] # 12
  - [[-1, 8], 1, Concat, [1]] # 13
  - [-1, 2, A2C2f, [512, False, -1]] # 14

  - [-1, 1, nn.Upsample, [None, 2, "nearest"]] # 15
  - [[-1, 5], 1, Concat, [1]] # 16
  - [-1, 2, A2C2f, [256, False, -1]] # 17 (P3/8-small)

  # ============ Downsample Path ============
  - [-1, 1, Conv, [256, 3, 2]] # 18
  - [[-1, 14], 1, Concat, [1]] # 19
  - [-1, 2, A2C2f, [512, False, -1]] # 20 (P4/16-medium)

  - [-1, 1, Conv, [512, 3, 2]] # 21
  - [[-1, 11], 1, Concat, [1]] # 22
  - [-1, 2, C3k2, [1024, True]] # 23 (P5/32-large)

  # ============ Detection Heads ============
  - [[17, 20, 23], 1, Detect, [nc]] # 24-Detect(P3, P4, P5)

# ================================================================================================
# RGBDGGFEFusionå‚æ•°è¯´æ˜
# ================================================================================================
# RGBDGGFEFusionå‚æ•°åˆ—è¡¨:
#   [rgb_channels, depth_channels, c_out, k, s, reduction, fusion, use_ggfe, ggfe_reduction, act]
#
# å‚æ•°è¯¦è§£:
#   - rgb_channels (int): RGBè¾“å…¥é€šé“æ•° (ä»ä¸Šä¸€å±‚è‡ªåŠ¨æ¨å¯¼)
#   - depth_channels (int): Depthè¾“å…¥é€šé“æ•° (64, ä¸åŸé…ç½®ä¸€è‡´)
#   - c_out (None): è¾“å‡ºé€šé“æ•° (Noneè¡¨ç¤ºè‡ªåŠ¨è®¡ç®—)
#   - k (3): å·ç§¯æ ¸å¤§å°
#   - s (2): æ­¥é•¿
#   - reduction (16): é—¨æ§èåˆçš„é€šé“ç¼©å‡æ¯”ä¾‹
#   - fusion ("gated_add"): èåˆæ¨¡å¼ - "gated_add" | "add" | "concat"
#   - use_ggfe (True): æ˜¯å¦å¯ç”¨GGFEæ¨¡å— âœ¨
#   - ggfe_reduction (8): GGFEæ³¨æ„åŠ›çš„é€šé“ç¼©å‡æ¯”ä¾‹
#   - act (True): æ˜¯å¦ä½¿ç”¨æ¿€æ´»å‡½æ•°
#
# æ¶ˆèå®éªŒ:
#   - ç¦ç”¨GGFE: å°† use_ggfe æ”¹ä¸º False
#   - è°ƒæ•´GGFEå¼ºåº¦: ä¿®æ”¹ ggfe_reduction (4: å¼º, 16: å¼±)

# ================================================================================================
# é¢„æœŸæ€§èƒ½æå‡
# ================================================================================================
#
# | Model     | Baseline AP | +GGFE AP | æå‡ | vs RemDet | å¤‡æ³¨ |
# |-----------|-------------|----------|------|-----------|------|
# | YOLO12-N  | 19.2%       | 20.5%    | +1.3%| Tiny 21.8%| 100epå¿«é€ŸéªŒè¯ |
# | YOLO12-N  | 19.2%       | 21.0%    | +1.8%| Tiny 21.8%| 300epå®Œæ•´è®­ç»ƒ |
# | YOLO12-S  | å¾…è®­ç»ƒ      | å¾…éªŒè¯   | +1-2%| S å¾…å¯¹æ¯”  | ä¸‹ä¸€é˜¶æ®µ |
# | YOLO12-M  | å¾…è®­ç»ƒ      | å¾…éªŒè¯   | +1-2%| M å¾…å¯¹æ¯”  | ä¸‹ä¸€é˜¶æ®µ |
#
# åˆ†é¡¹æŒ‡æ ‡é¢„æœŸ (YOLO12-N + GGFE, 300ep):
#   - AP@0.5:0.95: 19.2% â†’ 21.0% (+1.8%)
#   - AP_s: 9.9% â†’ 11.5% (+1.6%, å°ç›®æ ‡)
#   - AP_m: 29.6% â†’ 31.5% (+1.9%, ä¸­ç­‰ç›®æ ‡) â† GGFEä¸»è¦æå‡
#   - AP_l: 45.9% â†’ 46.5% (+0.6%, å¤§ç›®æ ‡)

# ================================================================================================
# è®­ç»ƒå»ºè®®
# ================================================================================================
#
# Phase 1: å¿«é€ŸéªŒè¯ (100 epochs)
#   - ç›®æ ‡: éªŒè¯GGFEæ˜¯å¦æœ‰æ•ˆ
#   - æ—¶é—´: 3-4å¤©
#   - å‘½ä»¤:
#     python train_depth_solr_v2.py \
#         --name visdrone_ggfe_n_100ep \
#         --data /path/to/visdrone-rgbd.yaml \
#         --device 4 \
#         --weights /path/to/yolo12n.pt \
#         --cfg n \
#         --medium_weight 2.5 \
#         --batch 16 \
#         --epochs 100
#
#   - æˆåŠŸæ ‡å‡†: AP@0.5:0.95 â‰¥ 20% (+0.8%)
#   - å¦‚æœæˆåŠŸ â†’ è¿›å…¥Phase 2
#   - å¦‚æœå¤±è´¥ â†’ è°ƒè¯•GGFEæˆ–å°è¯•å…¶ä»–æ–¹æ³•
#
# Phase 2: å®Œæ•´è®­ç»ƒ (300 epochs)
#   - ç›®æ ‡: è¾¾åˆ°æœ€ä½³æ€§èƒ½
#   - æ—¶é—´: 10å¤©
#   - å‘½ä»¤:
#     python train_depth_solr_v2.py \
#         --name visdrone_ggfe_n_300ep \
#         --data /path/to/visdrone-rgbd.yaml \
#         --device 4 \
#         --weights /path/to/yolo12n.pt \
#         --cfg n \
#         --medium_weight 2.5 \
#         --batch 16 \
#         --epochs 300
#
#   - æˆåŠŸæ ‡å‡†: AP@0.5:0.95 â‰¥ 21% (æ¥è¿‘RemDet-Tinyçš„21.8%)
#
# Phase 3: æ¶ˆèå®éªŒ (å¯é€‰)
#   - ç¦ç”¨GGFEï¼Œå¯¹æ¯”æå‡å¹…åº¦
#   - ä¿®æ”¹YAMLä¸­çš„ use_ggfe=False
#   - é‡æ–°è®­ç»ƒ100epï¼Œç¡®è®¤GGFEçš„è´¡çŒ®

# ================================================================================================
# ğŸ“š å…«è‚¡çŸ¥è¯†ç‚¹: GGFEæ¨¡å—é›†æˆ
# ================================================================================================
#
# Q1: RGBDGGFEFusion vs RGBDMidFusionæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
# A: æ ¸å¿ƒåŒºåˆ«æ˜¯**å‡ ä½•å¼•å¯¼çš„æ³¨æ„åŠ›å¢å¼º**:
#    - RGBDMidFusion: RGB + Depth â†’ é—¨æ§èåˆ â†’ è¾“å‡º
#    - RGBDGGFEFusion: RGB + Depth â†’ é—¨æ§èåˆ â†’ GGFEå¢å¼º â†’ è¾“å‡º
#
#    GGFEå¢å¼ºçš„ä½œç”¨:
#    1. ä»æ·±åº¦å›¾æå–å‡ ä½•å…ˆéªŒ (æ³•å‘é‡+è¾¹ç¼˜+è´¨é‡)
#    2. ç”Ÿæˆç©ºé—´æ³¨æ„åŠ›å›¾ (å…³æ³¨è¾¹ç•ŒåŒºåŸŸ)
#    3. ç”Ÿæˆé€šé“æ³¨æ„åŠ› (å¢å¼ºé‡è¦ç‰¹å¾)
#    4. ç”¨æ³¨æ„åŠ›åŠ æƒèåˆç‰¹å¾ (çªå‡ºç›®æ ‡ï¼ŒæŠ‘åˆ¶èƒŒæ™¯)
#
#    æ•ˆæœ: ä¸­å°ç›®æ ‡çš„è¾¹ç•Œæ›´æ¸…æ™°ï¼ŒAP_mæå‡æœ€æ˜æ˜¾
#
# Q2: use_ggfeå‚æ•°çš„ä½œç”¨ï¼Ÿå¦‚ä½•åšæ¶ˆèå®éªŒï¼Ÿ
# A: use_ggfeæ§åˆ¶æ˜¯å¦å¯ç”¨GGFEæ¨¡å—:
#    - use_ggfe=True: å®Œæ•´çš„RGBD+GGFE (é»˜è®¤)
#    - use_ggfe=False: ä»…RGBDèåˆï¼Œä¸ç”¨GGFE (æ¶ˆèå¯¹ç…§)
#
#    æ¶ˆèå®éªŒæµç¨‹:
#    1. è®­ç»ƒ use_ggfe=True æ¨¡å‹ (100ep)
#    2. è®­ç»ƒ use_ggfe=False æ¨¡å‹ (100ep)
#    3. å¯¹æ¯”APæŒ‡æ ‡ï¼Œè®¡ç®—GGFEçš„è´¡çŒ®
#
#    é¢„æœŸç»“æœ:
#    - use_ggfe=True: AP@0.5:0.95 = 20.5%
#    - use_ggfe=False: AP@0.5:0.95 = 19.5%
#    - GGFEè´¡çŒ®: +1.0%
#
# Q3: ggfe_reductionå‚æ•°å¦‚ä½•å½±å“æ€§èƒ½ï¼Ÿ
# A: ggfe_reductionæ§åˆ¶æ³¨æ„åŠ›ç½‘ç»œçš„é€šé“ç¼©å‡:
#    - reduction=4: æ³¨æ„åŠ›ç½‘ç»œæ›´å®½ â†’ è¡¨è¾¾èƒ½åŠ›å¼º â†’ å‚æ•°å¤š â†’ å¯èƒ½è¿‡æ‹Ÿåˆ
#    - reduction=8: é»˜è®¤å€¼ (å¹³è¡¡æ€§èƒ½å’Œå‚æ•°é‡)
#    - reduction=16: æ³¨æ„åŠ›ç½‘ç»œæ›´çª„ â†’ å‚æ•°å°‘ â†’ å¯èƒ½æ¬ æ‹Ÿåˆ
#
#    å‚æ•°é‡å¯¹æ¯” (ä»¥P4å±‚256é€šé“ä¸ºä¾‹):
#    - reduction=4: æ³¨æ„åŠ›å‚æ•° ~150K
#    - reduction=8: æ³¨æ„åŠ›å‚æ•° ~70K (é»˜è®¤)
#    - reduction=16: æ³¨æ„åŠ›å‚æ•° ~35K
#
#    å»ºè®®: å…ˆç”¨é»˜è®¤å€¼8ï¼Œå¦‚æœæ˜¾å­˜å……è¶³å¯å°è¯•4
#
# Q4: GGFEä¼šå¢åŠ å¤šå°‘è®¡ç®—å¼€é”€ï¼Ÿ
# A: è½»é‡çº§è®¾è®¡ï¼Œå¼€é”€å¾ˆå°:
#    - å‡ ä½•å…ˆéªŒæå–: 0 FLOPs (Sobelç®—å­ï¼Œéç¥ç»ç½‘ç»œ)
#    - ç©ºé—´æ³¨æ„åŠ›: ~0.5G FLOPs (å•ä¸ª1x1å·ç§¯+Sigmoid)
#    - é€šé“æ³¨æ„åŠ›: ~0.3G FLOPs (å…¨å±€æ± åŒ–+1x1å·ç§¯)
#    - æ€»å¼€é”€: ~0.8G FLOPs (å æ€»FLOPsçš„5%)
#
#    é€Ÿåº¦å½±å“: FPSä¸‹é™ < 5% (å‡ ä¹å¯å¿½ç•¥)
#
# Q5: GGFEé€‚åˆå“ªäº›æ•°æ®é›†ï¼Ÿ
# A: é€‚åˆ**æœ‰æ·±åº¦å›¾**ä¸”**å°ç›®æ ‡å¤š**çš„åœºæ™¯:
#    âœ… é€‚åˆ:
#    - VisDrone (UAV, å°ç›®æ ‡å¯†é›†)
#    - UAVDT (UAV, å°ç›®æ ‡)
#    - KITTI (è‡ªåŠ¨é©¾é©¶, è¿œè·ç¦»ç›®æ ‡)
#    - NYUv2-Det (å®¤å†…, æ·±åº¦å›¾è´¨é‡é«˜)
#
#    âŒ ä¸é€‚åˆ:
#    - COCO (æ— æ·±åº¦å›¾)
#    - VOC (æ— æ·±åº¦å›¾)
#    - æ·±åº¦å›¾å™ªå£°æå¤§çš„æ•°æ®é›† (å¦‚Webçˆ¬å–çš„ä¼ªæ·±åº¦)
#
#    åˆ¤æ–­æ ‡å‡†: æ·±åº¦å›¾SNR > 15dB, GGFEæ‰æœ‰æ•ˆ
# ================================================================================================
