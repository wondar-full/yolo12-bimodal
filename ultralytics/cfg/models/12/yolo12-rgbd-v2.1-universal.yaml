# Ultralytics YOLO ğŸš€, AGPL-3.0 license
# YOLO12 RGB-D v2.1 Universal Config (æ”¯æŒ n/s/m/l/x æ‰€æœ‰å°ºå¯¸)
# Created: 2025-11-16 for RemDet multi-scale experiments
# Goal: Train n/s/m/l/x models to compare with RemDet-Tiny/S/M/L/X

# ================================================================================================
# ä½¿ç”¨è¯´æ˜
# ================================================================================================
# è®­ç»ƒä¸åŒå°ºå¯¸æ¨¡å‹:
#
# YOLOv12-N (å¯¹æ ‡RemDet-Tiny):
#   python train_uav_joint.py --model ultralytics/cfg/models/12/yolo12-rgbd-v2.1-universal.yaml \
#       --cfg n --name rgbd_v2.1_n_joint_300ep
#
# YOLOv12-S (å¯¹æ ‡RemDet-S):
#   python train_uav_joint.py --model ultralytics/cfg/models/12/yolo12-rgbd-v2.1-universal.yaml \
#       --cfg s --name rgbd_v2.1_s_joint_300ep
#
# YOLOv12-M (å¯¹æ ‡RemDet-M):
#   python train_uav_joint.py --model ultralytics/cfg/models/12/yolo12-rgbd-v2.1-universal.yaml \
#       --cfg m --name rgbd_v2.1_m_joint_300ep
#
# YOLOv12-L (å¯¹æ ‡RemDet-L):
#   python train_uav_joint.py --model ultralytics/cfg/models/12/yolo12-rgbd-v2.1-universal.yaml \
#       --cfg l --name rgbd_v2.1_l_joint_300ep
#
# YOLOv12-X (å¯¹æ ‡RemDet-X):
#   python train_uav_joint.py --model ultralytics/cfg/models/12/yolo12-rgbd-v2.1-universal.yaml \
#       --cfg x --name rgbd_v2.1_x_joint_300ep

# ================================================================================================
# Model Configuration
# ================================================================================================
nc: 10 # Number of classes (VisDrone)

# Model compound scaling constants
# [depth_multiple, width_multiple, max_channels]
scales:
  n: [0.50, 0.25, 1024] # nano   - è½»é‡çº§ (~3M params, å¯¹æ ‡RemDet-Tiny)
  s: [0.50, 0.50, 1024] # small  - æ ‡å‡†   (~11M params, å¯¹æ ‡RemDet-S)
  m: [0.50, 1.00, 512] # medium - ä¸­å‹   (~22M params, å¯¹æ ‡RemDet-M)
  l: [1.00, 1.00, 512] # large  - å¤§å‹   (~44M params, å¯¹æ ‡RemDet-L)
  x: [1.00, 1.50, 512] # xlarge - è¶…å¤§   (~66M params, å¯¹æ ‡RemDet-X)

# ================================================================================================
# Backbone (Feature Extractor) - Multi-Scale RGB-D Fusion
# ================================================================================================
backbone:
  # [from, repeats, module, args]

  # ============ P1/2 Stage - Early Fusion ============
  - [-1, 1, RGBDStem, [4, 128, 3, 2, 1, 64, "gated_add", 16, True]] # 0-P1/2

  # ============ P2/4 Stage ============
  - [-1, 1, Conv, [128, 3, 2]] # 1-P2/4
  - [-1, 2, C3k2, [256, False, 0.25]] # 2

  # ============ P3/8 Stage - First Depth Re-injection ============
  - [-1, 1, Conv, [256, 3, 2]] # 3-P3/8
  - [-1, 2, C3k2, [512, False, 0.25]] # 4-P3 features
  - [[4, 0], 1, RGBDMidFusion, [512, 64]] # 5-P3 depth fusion âœ…

  # ============ P4/16 Stage - Second Depth Re-injection ============
  - [-1, 1, Conv, [512, 3, 2]] # 6-P4/16
  - [-1, 4, A2C2f, [512, True, 4]] # 7-P4 features
  - [[7, 0], 1, RGBDMidFusion, [512, 64]] # 8-P4 depth fusion âœ…

  # ============ P5/32 Stage - Third Depth Re-injection ============
  - [-1, 1, Conv, [1024, 3, 2]] # 9-P5/32
  - [-1, 4, A2C2f, [1024, True, 1]] # 10-P5 features
  - [[10, 0], 1, RGBDMidFusion, [1024, 64]] # 11-P5 depth fusion âœ…

# ================================================================================================
# Head (Detection) - Standard YOLOv12
# ================================================================================================
head:
  # ============ Upsample Path ============
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]] # 12
  - [[-1, 8], 1, Concat, [1]] # 13
  - [-1, 2, A2C2f, [512, False, -1]] # 14

  - [-1, 1, nn.Upsample, [None, 2, "nearest"]] # 15
  - [[-1, 5], 1, Concat, [1]] # 16
  - [-1, 2, A2C2f, [256, False, -1]] # 17 (P3/8-small)

  # ============ Downsample Path ============
  - [-1, 1, Conv, [256, 3, 2]] # 18
  - [[-1, 14], 1, Concat, [1]] # 19
  - [-1, 2, A2C2f, [512, False, -1]] # 20 (P4/16-medium)

  - [-1, 1, Conv, [512, 3, 2]] # 21
  - [[-1, 11], 1, Concat, [1]] # 22
  - [-1, 2, C3k2, [1024, True]] # 23 (P5/32-large)

  # ============ Detection Heads ============
  - [[17, 20, 23], 1, Detect, [nc]] # 24-Detect(P3, P4, P5)

# ================================================================================================
# Training Hyperparameters (RemDet-Aligned)
# ================================================================================================
# é€šç”¨è®­ç»ƒå‘½ä»¤æ¨¡æ¿:
#
# python train_uav_joint.py \
#     --model ultralytics/cfg/models/12/yolo12-rgbd-v2.1-universal.yaml \
#     --cfg [n/s/m/l/x] \
#     --data data/uav-joint-rgbd.yaml \
#     --epochs 300 \
#     --batch [16/8/4å–å†³äºæ¨¡å‹å¤§å°] \
#     --imgsz 640 \
#     --device 0 \
#     --name rgbd_v2.1_[n/s/m/l/x]_joint_300ep

# ================================================================================================
# æ¨¡å‹å°ºå¯¸å¯¹æ¯”ä¸æ¨èé…ç½®
# ================================================================================================
#
# | Model | Params | FLOPs | Batch | Memory | Time/Epoch | RemDetå¯¹æ ‡ |
# |-------|--------|-------|-------|--------|------------|-----------|
# | n     | ~3M    | ~8G   | 32    | ~8GB   | ~30min     | Tiny      |
# | s     | ~11M   | ~46G  | 16    | ~12GB  | ~1h        | S         |
# | m     | ~22M   | ~92G  | 8     | ~16GB  | ~2h        | M         |
# | l     | ~44M   | ~184G | 4     | ~20GB  | ~4h        | L         |
# | x     | ~66M   | ~276G | 2     | ~22GB  | ~6h        | X         |
#
# æ³¨æ„: æ—¶é—´åŸºäºRTX 4090, å®é™…æ—¶é—´ä¼šå› æ•°æ®åŠ è½½é€Ÿåº¦è€Œå¼‚

# ================================================================================================
# é¢„æœŸæ€§èƒ½ (VisDrone val, 300 epochs)
# ================================================================================================
#
# | Model     | AP@0.5 | AP@0.5:0.95 | AP_small | vs RemDet | å¤‡æ³¨ |
# |-----------|--------|-------------|----------|-----------|------|
# | RGB-D-N   | 36-38% | 22-23%      | 12-13%   | Tiny 33.5%| +RGB-Dä¼˜åŠ¿ |
# | RGB-D-S   | 46-48% | 28-29%      | 18-19%   | S 42.3%   | ä¸»åŠ›æ¨¡å‹ |
# | RGB-D-M   | 48-50% | 30-31%      | 20-21%   | M 45.0%   | æ€§ä»·æ¯”é«˜ |
# | RGB-D-L   | 50-52% | 31-32%      | 21-22%   | L 47.4%   | å¤§æ¨¡å‹ |
# | RGB-D-X   | 51-53% | 32-33%      | 22-23%   | X 48.3%   | ç»ˆæç›®æ ‡ |
#
# é¢„æœŸå¢ç›Šæ¥æº:
# - RGB-Dèåˆ: +3-4% AP@0.5 (å·²åœ¨v2.1éªŒè¯)
# - æ•°æ®æ‰©å……: +1.5-2% (VisDrone â†’ VisDrone+UAVDT)

# ================================================================================================
# ğŸ“š å…«è‚¡çŸ¥è¯†ç‚¹: æ¨¡å‹ç¼©æ”¾ç­–ç•¥
# ================================================================================================
#
# Q1: depth_multipleå’Œwidth_multipleçš„ä½œç”¨ï¼Ÿ
# A: æ¨¡å‹å¤åˆç¼©æ”¾çš„ä¸¤ä¸ªç»´åº¦:
#    - depth_multiple: æ§åˆ¶å±‚æ•°(repeats)
#      ä¾‹å¦‚: C3k2çš„repeats=2, åœ¨næ¨¡å‹ä¸­å˜ä¸º 2*0.5=1
#    - width_multiple: æ§åˆ¶é€šé“æ•°(channels)
#      ä¾‹å¦‚: Convè¾“å‡º256ch, åœ¨næ¨¡å‹ä¸­å˜ä¸º 256*0.25=64
#
#    YOLOv12çš„scalingç­–ç•¥:
#    - n: [0.5, 0.25] - å±‚æ•°å‡åŠ,é€šé“æ•°å‡è‡³1/4
#    - s: [0.5, 0.5]  - å±‚æ•°å‡åŠ,é€šé“æ•°å‡åŠ
#    - m: [0.5, 1.0]  - å±‚æ•°å‡åŠ,é€šé“æ•°ä¸å˜
#    - l: [1.0, 1.0]  - å±‚æ•°å’Œé€šé“æ•°éƒ½ä¸å˜(åŸºå‡†)
#    - x: [1.0, 1.5]  - å±‚æ•°ä¸å˜,é€šé“æ•°å¢åŠ 50%
#
# Q2: ä¸ºä»€ä¹ˆn/sç”¨1024 max_channelsè€Œm/l/xç”¨512ï¼Ÿ
# A: max_channelsé™åˆ¶æœ€å¤§é€šé“æ•°,é¿å…å†…å­˜çˆ†ç‚¸:
#    - n/s: ç½‘ç»œè¾ƒæµ…,å…è®¸æ›´å®½çš„channel
#    - m/l/x: ç½‘ç»œå·²ç»å¾ˆæ·±,éœ€è¦é™åˆ¶channelé¿å…OOM
#
#    å…·ä½“è®¡ç®—:
#    - Layer 11è¾“å‡º: 1024 * width_multiple
#      n: 1024 * 0.25 = 256 (< 1024, ä¸é™åˆ¶)
#      s: 1024 * 0.5 = 512 (< 1024, ä¸é™åˆ¶)
#      m: 1024 * 1.0 = 1024 (> 512, é™åˆ¶ä¸º512)
#      l: 1024 * 1.0 = 1024 (> 512, é™åˆ¶ä¸º512)
#      x: 1024 * 1.5 = 1536 (> 512, é™åˆ¶ä¸º512)
#
# Q3: è®­ç»ƒä¸åŒå°ºå¯¸æ¨¡å‹éœ€è¦è°ƒæ•´å­¦ä¹ ç‡å—ï¼Ÿ
# A: RemDetè®ºæ–‡æœªåŒºåˆ†,ä½†ç†è®ºä¸Š:
#    - å°æ¨¡å‹(n): å¯ä»¥ç”¨ç¨é«˜lr (0.015)
#    - å¤§æ¨¡å‹(l/x): ä¿æŒ0.01æˆ–é™ä½ (0.008)
#
#    åŸå› : å¤§æ¨¡å‹æ¢¯åº¦æ›´ç¨³å®š,ä½†éœ€è¦æ›´è°¨æ…çš„å­¦ä¹ 
#
#    å®è·µå»ºè®®: å…ˆç”¨ç»Ÿä¸€lr=0.01è®­ç»ƒ,è§‚å¯Ÿloss
#    - å¦‚æœlosséœ‡è¡ â†’ é™ä½lr
#    - å¦‚æœæ”¶æ•›å¤ªæ…¢ â†’ å¢åŠ lr
#
# Q4: batch sizeå¦‚ä½•é€‰æ‹©ï¼Ÿ
# A: åŸºäºæ˜¾å­˜é™åˆ¶å’Œæ¢¯åº¦è´¨é‡:
#    - n: batch=32 (å°æ¨¡å‹,å°½é‡å¤§batch)
#    - s: batch=16 (æ ‡å‡†é…ç½®)
#    - m: batch=8
#    - l: batch=4
#    - x: batch=2 (24GBæ˜¾å­˜æé™)
#
#    æ³¨æ„: nbs=128ä¿æŒä¸å˜(æ¢¯åº¦ç´¯ç§¯)
#    - n: accumulate = 128/32 = 4 steps
#    - s: accumulate = 128/16 = 8 steps
#    - x: accumulate = 128/2 = 64 steps
#
# Q5: å¤šå°ºå¯¸æ¨¡å‹è®­ç»ƒçš„ä¼˜å…ˆçº§ï¼Ÿ
# A: å»ºè®®é¡ºåº:
#    1. **sæ¨¡å‹** (ä¸»åŠ›,æ€§ä»·æ¯”é«˜,1å¤©è®­ç»ƒ)
#    2. **mæ¨¡å‹** (æå‡æ€§èƒ½,2å¤©è®­ç»ƒ)
#    3. **xæ¨¡å‹** (ç»ˆææ€§èƒ½,6å¤©è®­ç»ƒ)
#    4. **næ¨¡å‹** (å®æ—¶éƒ¨ç½²,å¿«é€ŸéªŒè¯)
#    5. **læ¨¡å‹** (å¯é€‰,ä»‹äºmå’Œxä¹‹é—´)
#
#    å¦‚æœåªèƒ½è®­ç»ƒä¸€ä¸ª: é€‰**sæ¨¡å‹**
#    å¦‚æœè¦å‘è®ºæ–‡: è‡³å°‘è®­ç»ƒ**s+m+x**åšå¯¹æ¯”
# ================================================================================================
