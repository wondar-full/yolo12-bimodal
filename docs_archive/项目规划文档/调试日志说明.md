# ğŸ” å°ºåº¦åˆ†ç±» Bug è°ƒè¯•æ—¥å¿—

## å½“å‰é—®é¢˜æ€»ç»“

### éªŒè¯è¾“å‡ºå¼‚å¸¸

```bash
ğŸ” Size-wise Statistics (First Batch):
  GT:   Small= 127, Medium=   0, Large=   0  â† âŒ GTå…¨æ˜¯Small
  Pred: Small=   0, Medium=   0, Large= 300  â† âŒ Predå…¨æ˜¯Large
  TP:   Small=   0, Medium=   0, Large=   0  â† âŒ æ— æ³•åŒ¹é…,TPå…¨0
```

### é—®é¢˜åˆ†æ

#### é—®é¢˜ 1: GT å…¨è¢«åˆ†ç±»ä¸º Small (127 ä¸ª)

**å¯èƒ½åŸå› **:

1. `dataset.py` ä¸­çš„ `target_areas` è®¡ç®—ä»ä½¿ç”¨äº† **åŸå§‹å›¾åƒå°ºå¯¸** è€Œé **resize åçš„ 640Ã—640**
2. æˆ–è€… `target_areas` æ ¹æœ¬æ²¡æœ‰è¢«æ­£ç¡®ä¼ é€’åˆ° `val.py`

**ä»£ç ä½ç½®**: `ultralytics/data/dataset.py` line 288-306

```python
if normalized:
    # ä¼˜å…ˆä½¿ç”¨resized_shape (éªŒè¯æ—¶bboxæ˜¯ç›¸å¯¹äºresizeåçš„å°ºå¯¸,è€ŒéåŸå§‹å°ºå¯¸)
    img_h, img_w = label.get("resized_shape", (640, 640))[:2]

    # âŒ å¦‚æœresized_shapeä¸å­˜åœ¨,å°è¯•ä»imgè·å–å®é™…å°ºå¯¸
    if "img" in label and label["img"] is not None:
        img_h, img_w = label["img"].shape[:2]  # â† è¦†ç›–äº†resized_shape!

    widths = widths * img_w
    heights = heights * img_h
```

**æ½œåœ¨ Bug**: å¦‚æœ `label["img"]` å­˜åœ¨ä¸”ä¸ä¸º None,ä¼šç”¨å®é™…å›¾åƒå°ºå¯¸è¦†ç›– `resized_shape`,å¯¼è‡´:

- åŸå§‹å›¾åƒ 1920Ã—1080
- bbox ç›¸å¯¹ resize åçš„ 640Ã—640 æ˜¯å½’ä¸€åŒ–çš„
- ä½†è®¡ç®—æ—¶ç”¨äº† 1920Ã—1080 â†’ é¢ç§¯è™šé«˜ â†’ é”™è¯¯åˆ†ç±»ä¸º Large

**è§£å†³æ–¹æ¡ˆ**: ç§»é™¤ `if "img" in label...` è¿™æ®µ fallback ä»£ç 

---

#### é—®é¢˜ 2: Pred å…¨è¢«åˆ†ç±»ä¸º Large (300 ä¸ª)

**å¯èƒ½åŸå› **:

1. `batch["imgsz"]` è¿”å›çš„ä¸æ˜¯ `(H, W)` å…ƒç»„,è€Œæ˜¯å•ä¸ªå€¼æˆ–é”™è¯¯æ ¼å¼
2. `preds["bboxes"]` ä¸æ˜¯å½’ä¸€åŒ–åæ ‡,è€Œæ˜¯å·²ç»æ˜¯åƒç´ åæ ‡

**ä»£ç ä½ç½®**: `ultralytics/models/yolo/detect/val.py` line 368-376

```python
img_h, img_w = batch["imgsz"]  # â† å¦‚æœ imgsz æ˜¯ 640 è€Œé (640, 640) ä¼šæŠ¥é”™
pred_widths = (preds["bboxes"][:, 2] - preds["bboxes"][:, 0]) * img_w
pred_heights = (preds["bboxes"][:, 3] - preds["bboxes"][:, 1]) * img_h
pred_areas = pred_widths * pred_heights
```

**æ½œåœ¨ Bug**:

- å¦‚æœ `preds["bboxes"]` å·²ç»æ˜¯åƒç´ åæ ‡ (0~640),å†ä¹˜ä»¥ 640 â†’ é¢ç§¯ Ã—640Â² = 409,600 â†’ å…¨æ˜¯ Large!
- æˆ–è€… `batch["imgsz"]` æ ¼å¼ä¸å¯¹,å¯¼è‡´ `img_h, img_w` èµ‹å€¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ è°ƒè¯•æ—¥å¿—ç¡®è®¤:

1. `batch["imgsz"]` çš„å€¼å’Œç±»å‹
2. `preds["bboxes"]` çš„èŒƒå›´ (0~1 å½’ä¸€åŒ– vs 0~640 åƒç´ )

---

## æ–°å¢è°ƒè¯•æ—¥å¿—

### æ—¥å¿— 1: å›¾åƒå°ºå¯¸è°ƒè¯•

```python
if not hasattr(self, '_imgsz_debug_printed'):
    LOGGER.info(f"\nğŸ” Image Size Debug:")
    LOGGER.info(f"  batch['imgsz'] = {batch['imgsz']} (type: {type(batch['imgsz'])})")
    LOGGER.info(f"  img_h={img_h}, img_w={img_w}")
    LOGGER.info(f"  GT bboxes range: {batch['bboxes'].min().item():.3f} ~ {batch['bboxes'].max().item():.3f}")
    LOGGER.info(f"  Pred bboxes range: {preds['bboxes'].min().item():.3f} ~ {preds['bboxes'].max().item():.3f}")
    self._imgsz_debug_printed = True
```

**è¾“å‡ºç¤ºä¾‹**:

```
ğŸ” Image Size Debug:
  batch['imgsz'] = (640, 640) (type: <class 'tuple'>)
  img_h=640, img_w=640
  GT bboxes range: 0.123 ~ 534.567  â† âœ… åƒç´ åæ ‡
  Pred bboxes range: 0.001 ~ 0.998  â† âœ… å½’ä¸€åŒ–åæ ‡
```

æˆ–é”™è¯¯æƒ…å†µ:

```
  batch['imgsz'] = 640 (type: <class 'int'>)  â† âŒ ä¸æ˜¯å…ƒç»„!
  GT bboxes range: 0.001 ~ 0.998  â† âŒ å½’ä¸€åŒ–,ä½†å½“æˆåƒç´ äº†
  Pred bboxes range: 12.3 ~ 625.4  â† âŒ åƒç´ ,ä½†å½“æˆå½’ä¸€åŒ–äº†
```

---

### æ—¥å¿— 2: GT é¢ç§¯åˆ†å¸ƒè°ƒè¯•

```python
if not hasattr(self, '_gt_areas_debug_printed'):
    LOGGER.info(f"\nğŸ” GT Areas Debug (First Batch):")
    LOGGER.info(f"  GT areas: min={gt_areas.min().item():.1f}, max={gt_areas.max().item():.1f}, mean={gt_areas.mean().item():.1f}")
    LOGGER.info(f"  Threshold: small<{small_thresh}, medium<{medium_thresh}")
    sample_areas = gt_areas[:10].cpu().numpy() if len(gt_areas) > 10 else gt_areas.cpu().numpy()
    LOGGER.info(f"  Sample areas (first 10): {sample_areas}")
    self._gt_areas_debug_printed = True
```

**è¾“å‡ºç¤ºä¾‹ (æ­£å¸¸)**:

```
ğŸ” GT Areas Debug (First Batch):
  GT areas: min=48.3, max=25678.9, mean=1456.7
  Threshold: small<1024, medium<9216
  Sample areas (first 10): [48.3, 125.6, 567.8, 2345.1, 145.2, 8765.3, 456.7, 12345.6, 234.5, 9012.4]
```

**è¾“å‡ºç¤ºä¾‹ (Bug!)**:

```
  GT areas: min=12.3, max=456.7, mean=124.5  â† âŒ å…¨éƒ½ < 1024,å…¨æ˜¯Small!
  Sample areas (first 10): [12.3, 45.6, 78.9, 123.4, 234.5, 345.6, 456.7, 123.4, 234.5, 345.6]
```

---

### æ—¥å¿— 3: Pred é¢ç§¯åˆ†å¸ƒè°ƒè¯•

```python
if not hasattr(self, '_pred_areas_debug_printed'):
    LOGGER.info(f"\nğŸ” Pred Areas Debug (First Batch):")
    LOGGER.info(f"  Pred areas: min={pred_areas.min().item():.1f}, max={pred_areas.max().item():.1f}, mean={pred_areas.mean().item():.1f}")
    sample_pred_areas = pred_areas[:10].cpu().numpy() if len(pred_areas) > 10 else pred_areas.cpu().numpy()
    LOGGER.info(f"  Sample pred areas (first 10): {sample_pred_areas}")
    self._pred_areas_debug_printed = True
```

**è¾“å‡ºç¤ºä¾‹ (Bug!)**:

```
  Pred areas: min=125678.9, max=987654.3, mean=456789.1  â† âŒ å…¨éƒ½ >> 9216,å…¨æ˜¯Large!
  Sample pred areas (first 10): [125678.9, 234567.8, 345678.9, ...]
```

---

## é¢„æœŸä¿®å¤åçš„è¾“å‡º

### æ­£å¸¸çš„å°ºåº¦åˆ†å¸ƒ (ä¿®å¤å)

```bash
ğŸ” Size-wise Statistics (First Batch):
  GT:   Small=  85, Medium=  32, Large=  10  â† âœ… æ­£å¸¸åˆ†å¸ƒ (Smallæœ€å¤š)
  Pred: Small= 180, Medium=  85, Large=  35  â† âœ… æ­£å¸¸åˆ†å¸ƒ
  TP:   Small= 180, Medium=  85, Large=  35  â† âœ… å¯ä»¥åŒ¹é…

Small objects - P: 0.234, R: 0.189, mAP50: 0.152, mAP50-95: 0.098
Medium objects - P: 0.387, R: 0.312, mAP50: 0.278, mAP50-95: 0.165
Large objects - P: 0.512, R: 0.456, mAP50: 0.423, mAP50-95: 0.289
```

### é¢ç§¯åˆ†å¸ƒ (ä¿®å¤å)

```
ğŸ” GT Areas Debug:
  GT areas: min=48.3, max=25678.9, mean=1456.7  â† âœ… åˆç†èŒƒå›´
  Sample areas: [48, 125, 567, 2345, 145, 8765, 456, 12345, 234, 9012]

ğŸ” Pred Areas Debug:
  Pred areas: min=35.2, max=18234.5, mean=2134.8  â† âœ… åˆç†èŒƒå›´
  Sample pred areas: [35, 156, 789, 3456, 234, 11234, 567, 15678, 345, 9876]
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### æ­¥éª¤ 1: ä¿®å¤ `dataset.py` çš„ fallback bug

**æ–‡ä»¶**: `ultralytics/data/dataset.py` line 291-299

**ä¿®æ”¹å‰**:

```python
if normalized:
    img_h, img_w = label.get("resized_shape", (640, 640))[:2]

    # âŒ åˆ é™¤è¿™æ®µ fallback
    if "img" in label and label["img"] is not None:
        img_h, img_w = label["img"].shape[:2]

    widths = widths * img_w
    heights = heights * img_h
```

**ä¿®æ”¹å**:

```python
if normalized:
    # âœ… ç›´æ¥ä½¿ç”¨ resized_shape,ä¸å†fallback
    img_h, img_w = label.get("resized_shape", (640, 640))[:2]

    widths = widths * img_w
    heights = heights * img_h
```

---

### æ­¥éª¤ 2: ä¸Šä¼ ä¿®æ”¹å¹¶é‡æ–°éªŒè¯

```bash
# æœ¬åœ°æäº¤
git add .
git commit -m "fix: æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—è¯Šæ–­å°ºåº¦åˆ†ç±»Bug"
git push

# æœåŠ¡å™¨æ‹‰å–
cd /data2/user/2024/lzy/yolo12-bimodal
git pull

# é‡æ–°è¿è¡Œè¯Šæ–­è„šæœ¬
python diagnose_metrics_output.py

# é‡æ–°éªŒè¯
CUDA_VISIBLE_DEVICES=7 sh val_depth.sh
```

---

### æ­¥éª¤ 3: åˆ†ææ–°çš„è°ƒè¯•è¾“å‡º

æ ¹æ®è¾“å‡ºåˆ¤æ–­:

**æƒ…å†µ 1: GT é¢ç§¯æ­£å¸¸,Pred é¢ç§¯å¼‚å¸¸**
â†’ é—®é¢˜åœ¨ `val.py` çš„ `batch["imgsz"]` æˆ– `preds["bboxes"]` æ ¼å¼
â†’ ä¿®å¤: æ£€æŸ¥ `_prepare_pred` æ–¹æ³•,ç¡®è®¤ bbox æ˜¯å¦å½’ä¸€åŒ–

**æƒ…å†µ 2: GT é¢ç§¯å¼‚å¸¸,Pred é¢ç§¯æ­£å¸¸**
â†’ é—®é¢˜åœ¨ `dataset.py` çš„ `target_areas` è®¡ç®—
â†’ ä¿®å¤: ç§»é™¤ fallback ä»£ç  (å¦‚æ­¥éª¤ 1)

**æƒ…å†µ 3: GT å’Œ Pred éƒ½å¼‚å¸¸**
â†’ æ ¹æœ¬é—®é¢˜: bbox åæ ‡ç³»ä¸ä¸€è‡´ (å½’ä¸€åŒ– vs åƒç´ )
â†’ ä¿®å¤: ç»Ÿä¸€åæ ‡ç³»,ç¡®ä¿ `_prepare_batch` å’Œ `_prepare_pred` è¾“å‡ºä¸€è‡´

---

## å…«è‚¡çŸ¥è¯†ç‚¹è¡¥å……

### ğŸ“š å…«è‚¡ #025: å½’ä¸€åŒ–åæ ‡ vs åƒç´ åæ ‡

**Q: ä»€ä¹ˆæ˜¯å½’ä¸€åŒ–åæ ‡?ä¸ºä»€ä¹ˆè¦ç”¨?**

**A: å½’ä¸€åŒ–åæ ‡çš„å®šä¹‰ä¸ä¼˜åŠ¿**

1. **å®šä¹‰**:

   ```python
   # å½’ä¸€åŒ–åæ ‡ (0~1)
   bbox_norm = [x_center/W, y_center/H, width/W, height/H]
   # ç¤ºä¾‹: [0.5, 0.5, 0.2, 0.3] è¡¨ç¤ºä¸­å¿ƒåœ¨å›¾åƒæ­£ä¸­,å®½20%é«˜30%

   # åƒç´ åæ ‡ (0~W, 0~H)
   bbox_pixel = [x_center, y_center, width, height]
   # ç¤ºä¾‹: [320, 240, 128, 192] è¡¨ç¤ºä¸­å¿ƒåœ¨(320,240),å®½128åƒç´ é«˜192åƒç´ 
   ```

2. **ä¼˜åŠ¿**:

   - **å°ºåº¦æ— å…³**: 640Ã—640 å’Œ 1920Ã—1080 ç”¨åŒæ ·çš„å½’ä¸€åŒ–å€¼
   - **æ•°å€¼ç¨³å®š**: 0~1 èŒƒå›´,é¿å…å¤§æ•°å€¼æ¢¯åº¦çˆ†ç‚¸
   - **æ˜“äºæ•°æ®å¢å¼º**: ç¼©æ”¾/è£å‰ªåªéœ€è°ƒæ•´å½’ä¸€åŒ–ç³»æ•°

3. **YOLO çš„åæ ‡ç³»**:

   - **è¾“å…¥**: å½’ä¸€åŒ–åæ ‡ (label æ–‡ä»¶ä¸­çš„ 0~1 å€¼)
   - **ç½‘ç»œè¾“å‡º**: å½’ä¸€åŒ–åæ ‡ (sigmoid æ¿€æ´»,0~1)
   - **NMS å‰**: åƒç´ åæ ‡ (ä¹˜ä»¥ img_size,æ–¹ä¾¿ IoU è®¡ç®—)
   - **æœ€ç»ˆè¾“å‡º**: åƒç´ åæ ‡ (ç”¨æˆ·å‹å¥½)

4. **å¸¸è§é™·é˜±**:

   ```python
   # âŒ é”™è¯¯: å½’ä¸€åŒ–é¢ç§¯ vs åƒç´ é˜ˆå€¼
   area_norm = 0.05 * 0.05 = 0.0025
   if area_norm < 1024:  # æ°¸è¿œTrue! (0.0025 < 1024)
       print("Small")  # â† Bug: å…¨éƒ¨ç›®æ ‡éƒ½æ˜¯Small

   # âœ… æ­£ç¡®: ç»Ÿä¸€å•ä½
   area_pixel = (0.05 * 640) * (0.05 * 640) = 1024
   if area_pixel < 1024:
       print("Small")  # â† æ­£ç¡®åˆ†ç±»
   ```

5. **è°ƒè¯•æŠ€å·§**:

   ```python
   # æ‰“å°bboxèŒƒå›´å¿«é€Ÿåˆ¤æ–­åæ ‡ç³»
   print(f"bbox range: {bbox.min():.3f} ~ {bbox.max():.3f}")

   # å½’ä¸€åŒ–: 0.001 ~ 0.998
   # åƒç´ :   12.3 ~ 625.4
   ```

**RemDet å¯¹é½**: RemDet è®ºæ–‡åœ¨è®¡ç®— mAP_small æ—¶ä½¿ç”¨ **åƒç´ é¢ç§¯é˜ˆå€¼** (1024 pixelsÂ²),æˆ‘ä»¬å¿…é¡»ç¡®ä¿:

1. GT çš„ `target_areas` æ˜¯åƒç´ é¢ç§¯
2. Pred çš„é¢ç§¯è®¡ç®—ä¹Ÿæ˜¯åƒç´ é¢ç§¯
3. é˜ˆå€¼æ¯”è¾ƒæ—¶å•ä½ä¸€è‡´

---

### ğŸ“š å…«è‚¡ #026: YOLO çš„æ•°æ®æµè½¬

**Q: ä»æ•°æ®é›†åŠ è½½åˆ°æœ€ç»ˆè¾“å‡º,bbox ç»å†äº†å“ªäº›å˜æ¢?**

**A: å®Œæ•´çš„æ•°æ®æµè½¬é“¾è·¯**

```mermaid
graph LR
A[Labelæ–‡ä»¶<br/>å½’ä¸€åŒ–0~1] --> B[Dataset<br/>target_areasè®¡ç®—]
B --> C[DataLoader<br/>Batchæ‹¼æ¥]
C --> D[Preprocess<br/>è½¬Tensor+å½’ä¸€åŒ–]
D --> E[Model Forward<br/>è¾“å‡ºå½’ä¸€åŒ–bbox]
E --> F[Postprocess<br/>è½¬åƒç´ +NMS]
F --> G[_prepare_pred<br/>å‡†å¤‡éªŒè¯]
G --> H[_process_batch<br/>è®¡ç®—TP]
H --> I[Metrics<br/>è®¡ç®—mAP]
```

**å…³é”®å˜æ¢ç‚¹**:

1. **Dataset (`get_labels`)**:

   ```python
   # è¾“å…¥: labelæ–‡ä»¶çš„å½’ä¸€åŒ–åæ ‡
   bbox_norm = [0.5, 0.5, 0.2, 0.3]

   # è¾“å‡º: æ·»åŠ  target_areas (åƒç´ é¢ç§¯)
   img_h, img_w = label.get("resized_shape", (640, 640))
   width_pixel = 0.2 * 640 = 128
   height_pixel = 0.3 * 640 = 192
   target_area = 128 * 192 = 24576 pixelsÂ²
   ```

2. **Model Forward**:

   ```python
   # è¾“å…¥: å½’ä¸€åŒ–å›¾åƒ (0~1) + å½’ä¸€åŒ–bbox
   # è¾“å‡º: å½’ä¸€åŒ–é¢„æµ‹ (sigmoidæ¿€æ´»,0~1)
   pred_bbox_norm = [0.52, 0.48, 0.18, 0.25]
   ```

3. **Postprocess (NMS)**:

   ```python
   # è½¬åƒç´ åæ ‡æ–¹ä¾¿IoUè®¡ç®—
   pred_bbox_pixel = pred_bbox_norm * img_size
   # [0.52*640, 0.48*640, 0.18*640, 0.25*640]
   # = [332.8, 307.2, 115.2, 160.0]
   ```

4. **\_prepare_batch** (GT):

   ```python
   # è¾“å…¥: å½’ä¸€åŒ–bbox (ä»dataset)
   # è¾“å‡º: åƒç´ bbox (for IoUè®¡ç®—)
   gt_bbox = ops.xywh2xyxy(bbox_norm) * torch.tensor([W, H, W, H])
   # [0.4, 0.35, 0.6, 0.65] * [640, 640, 640, 640]
   # = [256, 224, 384, 416] (xyxyæ ¼å¼)
   ```

5. **\_prepare_pred** (Pred):

   ```python
   # è¾“å…¥: NMSåçš„åƒç´ bbox
   # è¾“å‡º: ä¿æŒåƒç´ åæ ‡ (å·²ç»æ˜¯xyxyæ ¼å¼)
   pred_bbox = pred["bboxes"]  # å·²ç»æ˜¯åƒç´ åæ ‡
   ```

6. **\_process_batch** (é¢ç§¯è®¡ç®—):

   ```python
   # GT: ç›´æ¥ç”¨ target_areas (å·²ç»æ˜¯åƒç´ )
   gt_areas = batch["target_areas"]  # [24576, ...]

   # Pred: ä»åƒç´ bboxè®¡ç®—
   pred_width = (pred[:, 2] - pred[:, 0])  # å·²ç»æ˜¯åƒç´ 
   pred_height = (pred[:, 3] - pred[:, 1])
   pred_areas = pred_width * pred_height  # åƒç´ é¢ç§¯
   ```

**å½“å‰ Bug**: åœ¨æŸä¸ªç¯èŠ‚,åæ ‡ç³»ä¸ä¸€è‡´å¯¼è‡´:

- GT ç”¨äº†åŸå§‹å›¾åƒå°ºå¯¸ (1920Ã—1080) â†’ é¢ç§¯è™šé«˜
- æˆ– Pred é‡å¤ä¹˜ä»¥ img_size â†’ é¢ç§¯è™šé«˜

**è°ƒè¯•ç­–ç•¥**: åœ¨æ¯ä¸ªå…³é”®ç‚¹æ‰“å° `bbox.min()~bbox.max()`,ç¡®è®¤åæ ‡ç³»æ­£ç¡®ã€‚
