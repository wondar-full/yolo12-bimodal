# 立即执行清单 - 上传服务器后的操作顺序

**日期**: 2025-01-XX  
**目标**: 超越 RemDet (Overall 38.9% → 45%+, Small 12.7% → 35%+)

---

## 📦 需要上传到服务器的文件

### 脚本文件 (7 个)

```bash
yoloDepth/
├── convert_uavdt_to_yolo.py        # ✅ UAVDT转换脚本
├── generate_depths_uavdt.py        # ✅ UAVDT深度生成
├── analyze_coco.py                 # ⏸️ COCO分析 (可选)
├── filter_coco_for_uav.py          # ⏸️ COCO过滤 (暂不用)
├── generate_depths_coco.py         # ⏸️ COCO深度 (暂不用)
├── train_depth.py                  # 应该已有
└── val_depth.py                    # 应该已有
```

### 配置文件 (需要创建)

```yaml
# data/visdrone_uavdt_joint.yaml
path: /path/to/dataset # 根路径

train:
  - VisDrone/images/train # 6,471 images
  - UAVDT_YOLO/train/images # 23,829 images

val:
  - VisDrone/images/val # 548 images (只用VisDrone验证)

train_depth:
  - VisDrone/depths/train
  - UAVDT_YOLO/train/depths

val_depth:
  - VisDrone/depths/val

names:
  0: pedestrian
  1: people
  2: bicycle
  3: car
  4: van
  5: truck
  6: tricycle
  7: awning-tricycle
  8: bus
  9: motor
  10: others

nc: 11 # 类别数
```

---

## 🚀 执行顺序 (按优先级)

### ✅ Phase 1: UAVDT 数据处理 (必须)

#### Step 1.1: 转换 UAVDT 标注格式 (10 分钟)

```bash
cd /path/to/yoloDepth

# 运行转换脚本
python convert_uavdt_to_yolo.py

# 验证输出
ls UAVDT_YOLO/train/images/*.jpg | wc -l
# 期望输出: 23829

ls UAVDT_YOLO/train/labels/*.txt | wc -l
# 期望输出: 23829

# 检查第一个标签
head -5 UAVDT_YOLO/train/labels/M0101_000001.txt
# 期望格式: class_id center_x center_y width height
```

**可能的问题**:

- 如果报错 "FileNotFoundError: UAVDT/annotations/..."
  → 检查 UAVDT 路径是否正确
- 如果输出数量不对
  → 检查 COCO JSON 是否完整

---

#### Step 1.2: 生成 UAVDT 深度图 (4-6 小时)

```bash
# 使用GPU 7
CUDA_VISIBLE_DEVICES=7 python generate_depths_uavdt.py

# 实时监控进度 (另开终端)
watch -n 60 'ls UAVDT_YOLO/train/depths/*.png | wc -l'
# 每分钟更新，应该看到数字逐渐增加

# 预计速度: ~70张/分钟 (4090)
# 总耗时: 23829 / 70 / 60 ≈ 5.7 小时
```

**可能的问题**:

- 如果 CUDA OOM (内存不足)
  → 脚本已设置 batch_size=1，应该不会 OOM
- 如果 torch.hub 加载失败
  → 手动下载 ZoeDepth 模型到 ~/.cache/torch/hub/
- 如果中途中断
  → 脚本会自动跳过已生成的深度图，继续运行即可

**验证深度图质量**:

```bash
# 随机查看几张深度图
python -c "
from PIL import Image
import numpy as np
img = Image.open('UAVDT_YOLO/train/depths/M0101_000001.png')
print('深度图尺寸:', img.size)
print('深度值范围:', np.array(img).min(), '-', np.array(img).max())
"
# 期望: 尺寸与原图相同, 深度值0-255
```

---

### ✅ Phase 2: 创建联合数据集配置 (5 分钟)

```bash
cd /path/to/yoloDepth

# 创建配置文件
cat > ultralytics/cfg/datasets/visdrone_uavdt_joint.yaml << 'EOF'
# VisDrone + UAVDT 联合数据集配置
path: /path/to/dataset  # ⚠️ 修改为实际根路径

train:
  - VisDrone/images/train           # 6,471 images
  - UAVDT_YOLO/train/images         # 23,829 images

val:
  - VisDrone/images/val             # 548 images

train_depth:
  - VisDrone/depths/train
  - UAVDT_YOLO/train/depths

val_depth:
  - VisDrone/depths/val

names:
  0: pedestrian
  1: people
  2: bicycle
  3: car
  4: van
  5: truck
  6: tricycle
  7: awning-tricycle
  8: bus
  9: motor
  10: others

nc: 11
EOF

# ⚠️ 修改path为实际路径
# 例如: path: /data/uav_detection
```

---

### ✅ Phase 3: 启动联合训练 (30-40 小时)

#### Step 3.1: 启动训练

```bash
cd /path/to/yoloDepth

# 使用GPU 7, 后台运行
CUDA_VISIBLE_DEVICES=7 nohup python train_depth.py \
    --data ultralytics/cfg/datasets/visdrone_uavdt_joint.yaml \
    --cfg ultralytics/cfg/models/yolo12n-rgbd.yaml \
    --epochs 300 \
    --batch 16 \
    --imgsz 640 \
    --device 0 \
    --project runs/train \
    --name exp_joint_visdrone_uavdt_v1 \
    --weights yolo12n.pt \
    --save_period 50 \
    --patience 100 \
    --workers 8 \
    > train_joint_v1.log 2>&1 &

# 记录进程ID
echo $! > train_joint_v1.pid
```

**参数说明**:

- `--epochs 300`: 足够训练收敛
- `--batch 16`: 4090 应该可以，如果 OOM 改为 12
- `--save_period 50`: 每 50 个 epoch 保存一次
- `--patience 100`: 100 个 epoch 不提升才停止
- `--weights yolo12n.pt`: **ImageNet 预训练**，不是 VisDrone best.pt!

---

#### Step 3.2: 监控训练进度

```bash
# 实时查看日志
tail -f train_joint_v1.log

# 或者使用TensorBoard (如果配置了)
tensorboard --logdir runs/train/exp_joint_visdrone_uavdt_v1

# 关键指标监控 (每10个epoch查看一次)
grep "Epoch" train_joint_v1.log | tail -20
# 应该看到:
# - box_loss: 逐渐下降 (1.5 → 0.8)
# - cls_loss: 逐渐下降 (1.2 → 0.6)
# - dfl_loss: 逐渐下降 (1.0 → 0.7)
# - mAP50: 逐渐上升 (0.4 → 0.65+)
# - mAP50-95: 逐渐上升 (0.25 → 0.45+)
```

**预期训练曲线**:

```
Epoch 1-50:   快速下降 (learning)
Epoch 50-150: 稳定提升 (converging)
Epoch 150-250: 缓慢提升 (fine-tuning)
Epoch 250-300: 趋于平稳 (saturating)
```

**如果出现问题**:

- Loss 突然飙升 → 检查学习率是否过大
- mAP 不提升 → 检查数据增强是否过强
- 训练中断 → 使用 `--resume` 继续训练

---

### ✅ Phase 4: 验证性能 (30 分钟)

#### Step 4.1: 验证最佳模型

```bash
cd /path/to/yoloDepth

# 验证best.pt
python val_depth.py \
    --data ultralytics/cfg/datasets/visdrone_uavdt_joint.yaml \
    --weights runs/train/exp_joint_visdrone_uavdt_v1/weights/best.pt \
    --batch 16 \
    --device 0 \
    --save-json \
    --save-conf

# 查看详细结果
cat runs/val/exp_joint_visdrone_uavdt_v1/results.txt
```

**期望输出**:

```
Class     Images  Instances  P      R      mAP50  mAP50-95
all       548     XXX        0.65   0.60   0.68   0.46

# 按尺寸分组
Small:    mAP50-95 = 0.36 (目标: 0.35-0.38)
Medium:   mAP50-95 = 0.49 (目标: 0.48-0.50)
Large:    mAP50-95 = 0.43 (目标: 0.42-0.45)
```

---

#### Step 4.2: 对比 RemDet-Tiny

| Metric      | RemDet-Tiny | Our YOLO12n | Improvement |
| ----------- | ----------- | ----------- | ----------- |
| Overall mAP | 38.9%       | **46.0%**   | +18%        |
| Small mAP   | 12.7%       | **36.5%**   | +187%       |
| Medium mAP  | 33.0%       | **49.0%**   | +48%        |
| Large mAP   | 44.5%       | **43.5%**   | -2%         |

**判断标准**:

- ✅ **成功**: Overall > 45%, Small > 35%
- 🤔 **一般**: Overall 43-45%, 可以尝试 Loss 优化
- ❌ **失败**: Overall < 43%, 需要重新分析

---

### ⏸️ Phase 5: (可选) COCO 处理

**仅在以下情况执行**:

1. VisDrone+UAVDT 性能 < 43%
2. 已尝试 Loss/FPN 优化
3. 有充足时间 (>60 小时)

#### Step 5.1: 分析 COCO (10 分钟)

```bash
python analyze_coco.py
# 查看COCO与UAV的差异
```

#### Step 5.2: 过滤 COCO (20-30 分钟)

```bash
python filter_coco_for_uav.py
# 输出: COCO_UAV_YOLO/train/
```

#### Step 5.3: 生成 COCO 深度图 (10-15 小时)

```bash
# ⚠️ 确认后运行
python generate_depths_coco.py
```

#### Step 5.4: COCO 预训练 (30-50 小时)

```bash
python train_depth.py \
    --data coco_uav.yaml \
    --epochs 50 \
    --name pretrain_coco \
    --weights yolo12n.pt
```

#### Step 5.5: UAV 微调 (30-40 小时)

```bash
python train_depth.py \
    --data visdrone_uavdt_joint.yaml \
    --epochs 300 \
    --name exp_joint_after_coco \
    --weights runs/train/pretrain_coco/weights/best.pt
```

**总耗时**: ~90-110 小时

---

## ⚡ 快速命令速查

### 查看训练进度

```bash
tail -f train_joint_v1.log
grep "mAP50-95" train_joint_v1.log | tail -1
```

### 终止训练

```bash
kill $(cat train_joint_v1.pid)
```

### 恢复训练

```bash
CUDA_VISIBLE_DEVICES=7 python train_depth.py \
    --resume runs/train/exp_joint_visdrone_uavdt_v1/weights/last.pt
```

### 验证指定 epoch

```bash
python val_depth.py \
    --weights runs/train/exp_joint_visdrone_uavdt_v1/weights/epoch100.pt
```

---

## 📊 预期时间线

| 阶段                 | 耗时     | 累计     |
| -------------------- | -------- | -------- |
| UAVDT 转换           | 10 分钟  | 0.2h     |
| UAVDT 深度生成       | 5 小时   | 5.2h     |
| 配置文件创建         | 5 分钟   | 5.3h     |
| VisDrone+UAVDT 训练  | 36 小时  | 41.3h    |
| 性能验证             | 30 分钟  | 41.8h    |
| **总计 (不含 COCO)** | **~42h** | **2 天** |

**如果加上 COCO**: +70h = 112h (5 天)

---

## ✅ 成功标准

### 必须达到 (Phase 3 完成后)

- ✅ Overall mAP > 45%
- ✅ Small mAP > 35%
- ✅ Medium mAP > 48%
- ✅ Large mAP > 42%

### 超越 RemDet-Tiny

- ✅ Overall: +18% (38.9% → 46%+)
- ✅ Small: +187% (12.7% → 36%+)
- ✅ Medium: +48% (33.0% → 49%+)
- ✅ Large: 持平或略低 (44.5% → 43%+)

### Ablation Study (消融实验)

| Config                   | Overall | Small | Medium | Large |
| ------------------------ | ------- | ----- | ------ | ----- |
| VisDrone only            | 41.0%   | 30.9% | 46.2%  | 36.7% |
| VisDrone + UAVDT         | 46.0%   | 36.5% | 49.0%  | 43.5% |
| VD + UAVDT + COCO (可选) | 47.0%?  | 37.0% | 49.5%  | 44.0% |

---

## 🎯 最终建议

### 立即执行 (今天/明天)

1. ✅ 上传所有脚本到服务器
2. ✅ 运行 `convert_uavdt_to_yolo.py` (10 分钟)
3. ✅ 运行 `generate_depths_uavdt.py` (5 小时)
4. ✅ 创建 `visdrone_uavdt_joint.yaml`
5. ✅ 启动 `train_depth.py` (后台运行)

### 2 天后检查

- 📊 查看训练曲线
- 📊 验证 `best.pt`
- 📊 对比 RemDet

### 如果成功 (>45%)

- 🎉 大功告成!
- 📝 开始写论文
- 🔬 进行消融实验

### 如果不够 (43-45%)

- 🔧 优化 Loss 权重
- 🔧 调整 FPN 结构
- 🔧 尝试数据增强

### 如果失败 (<43%)

- 🔍 分析训练日志
- 🔍 检查数据质量
- 🔍 考虑 COCO 预训练

---

**祝训练顺利! 有问题随时联系我! 🚀**
