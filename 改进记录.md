# 改进记录（2025/10/12）

## 背景
- 目标：在 Ultralytics YOLOv12（PyTorch）基础上，引入红外/深度额外模态以提升 VisDrone 数据集上的检测性能。
- 初始状态：代码仅支持单模态 RGB 输入，模型首层卷积权重为 3 通道，数据加载器无法感知深度图路径。
- 策略：采用早期融合（Early Fusion），在输入阶段将深度图拼接为第四通道，同时确保训练流程、损失函数与锚框逻辑仍按 YOLOv12 默认实现运行。

## 时间线与修改细节

### 2025/10/12 09:30 — 数据集加载器双模态改造
- **涉及文件**：`ultralytics/data/dataset.py`
- **修改内容**：
  - 扩展数据集初始化，解析 YAML 中的 `train_depth`、`val_depth` 字段，建立 RGB 与深度根目录配对关系。
  - 为 `YOLODataset` 增加 `_match_depth_path` 逻辑，根据 RGB 图像的相对路径自动定位同名深度图，实现样本一一对应。
  - 在 `load_image` 中加载深度图，与 RGB 数据在宽高维度对齐后进行通道拼接，写入缓存以兼容 Mosaic、Cache 等增强模式。
- **设计原理**：
  - 采用早期融合，使两个模态共享同一套 Backbone/Head，不改动后续检测逻辑即可复用 YOLOv12 原生损失与推理。
  - 通过路径相对定位保证目录结构灵活，支持不同后缀（.png/.tiff 等）及大小写差异。

### 2025/10/12 11:00 — 深度路径鲁棒性与归一化
- **涉及文件**：`ultralytics/data/dataset.py`
- **修改内容**：
  - 增加 `_collect_existing_dirs`、`_resolve_modal_roots`，确保相对路径在数据集根目录下自动展开，避免因启动路径不同导致的找不到文件。
  - 对加载后的深度图执行 `np.nan_to_num` 清洗无效值，并按最大像素值归一化再拉伸至 0–255，提高模态间动态范围对齐程度。
  - 若深度图尺寸与 RGB 不一致，则使用最近邻插值进行对齐，保留离散深度层级。
- **设计原理**：
  - 保障数据预处理的可复现性与数值稳定性，减少 NaN/Inf 对损失的影响。
  - 避免双线性插值引入跨像素混叠，以保持深度边缘信息。

### 2025/10/12 14:00 — 模型首层权重扩展
- **涉及文件**：`ultralytics/nn/tasks.py`
- **修改内容**：
  - 在加载预训练权重时检测输入通道数差异，若目标模型为 4 通道，则将首层卷积权重按 RGB 均值拓展到第四通道。
  - 保持权重尺度一致，并复用原有归一化参数，避免重新随机初始化带来的梯度震荡。
- **设计原理**：
  - 基于迁移学习原则，使用 RGB 权重的统计特性为新通道提供合理初始点。
  - 确保模型结构改动后仍可无缝复用官方 `yolo12s.pt` 等预训练模型，加速收敛。

### 2025/10/12 16:30 — 训练脚本初始化策略调整
- **涉及文件**：`train_depeth.py`
- **修改内容**：
  - 指定 `model = YOLO("yolo12s.pt")`，并在 `train()` 中传入自定义数据集配置 `mydataDepth.yml`。
  - 显式设置 `device`、`batch`、`imgsz` 等关键参数，保证实验可复现。
- **设计原理**：
  - 利用 Ultralytics 训练 API 的一致接口，确保额外模态仅通过 YAML 和数据加载器接入，不影响调度器与日志系统。

### 2025/10/12 21:00 — 灰度深度图兼容性修复
- **涉及文件**：`ultralytics/data/dataset.py`
- **修改内容**：
  - 针对部分深度图已为单通道的情况，跳过 `cv2.cvtColor(..., COLOR_BGR2GRAY)`，直接压缩多余维度，避免 OpenCV 报错（Bad number of channels）。
  - 保留对 3 通道深度图的转换分支，兼容伪彩色深度图。
- **设计原理**：
  - 匹配数据源的真实格式，减少不必要的色彩空间变换。
  - 统一最终拼接后的张量 dtype，保证 AMP 训练稳定。

## 训练与验证
- 命令：在项目根目录执行 `python train_depeth.py`
- 结果：训练运行至 EarlyStopping，在第 103 轮取得最佳权重 `runs/train/visdrone35/weights/best.pt`。
- 指标（Val 集）：`mAP50 = 0.401`，`mAP50-95 = 0.243`
- 日志：出现零星 "Non-finite gradients" 警告，训练流程自动跳过该 batch 并继续，不影响整体收敛。

## 经验总结与后续建议
1. **深度模态预处理**：保持与 RGB 尺寸一致并进行归一化是获得稳定梯度的关键，可进一步尝试直方图均衡或自适应增益。
2. **通道扩展策略**：若未来引入更多模态（如热成像+深度），建议考虑中期融合（例如在 C3/C2 模块连接处拼接）以保留模态特征独立性。
3. **训练稳定性**：针对非有限梯度，可在超参中启用梯度裁剪或降低学习率；若深度图噪声较大，可在数据管线中加入中值滤波。
4. **评估与可视化**：建议对比 RGB 单模态与 RGB+深度双模态的 PR 曲线和错误分析，验证改动带来的实质收益。
