# Loss 权重改进实验记录

## 🎯 实验目标

验证尺寸自适应 Loss 加权对 Small 目标检测性能的提升效果。

## 📋 实验配置

### 改进内容

- **Loss 权重调整**: 根据 GT 目标尺寸动态调整 Loss 权重
  - Small 目标 (<32×32): Loss 权重 ×2.0 ✅
  - Medium 目标 (32~96): Loss 权重 ×1.5 ✅
  - Large 目标 (≥96×96): Loss 权重 ×1.0 ✅

### 训练参数

- **模型**: YOLO12n-RGBD
- **数据集**: VisDrone2019-DET
- **训练图像**: 6,471
- **验证图像**: 548
- **Epochs**: 300
- **Batch Size**: 16
- **Image Size**: 640×640
- **GPU**: RTX 4090 (Device 7)
- **预训练权重**: yolo12n.pt (ImageNet)

### 代码修改

- **文件**: `ultralytics/utils/loss.py`
- **类**: `v8DetectionLoss`
- **方法**: `__call__`
- **修改位置**: Line 278-318
- **Git Commit**: (待填写)

## 📊 Baseline 性能 (参考)

| 指标            | Baseline | 备注         |
| --------------- | -------- | ------------ |
| Overall mAP@0.5 | ~41%     | 总体精度     |
| Small mAP       | 30.94%   | 小目标精度   |
| Medium mAP      | 46.24%   | 中等目标精度 |
| Large mAP       | 36.70%   | 大目标精度   |
| Precision       | ?        | 待补充       |
| Recall          | ?        | 待补充       |
| FPS             | ~35      | RTX 4090     |

## 🚀 训练过程记录

### 启动时间

- **开始时间**: (待填写)
- **预计完成**: (待填写, +15-20 小时)

### 训练命令

```bash
CUDA_VISIBLE_DEVICES=7 python train_depth.py \
    --data data/visdrone-rgbd.yaml \
    --epochs 300 \
    --batch 16 \
    --img 640 \
    --device 0 \
    --project runs/train \
    --name exp_loss_weighted_v1 \
    --weights yolo12n.pt \
    --cache \
    --save-period 50 \
    --patience 100 \
    --workers 8
```

### 关键节点记录

#### Epoch 50 (首个 checkpoint)

- **时间**: (待填写)
- **mAP@0.5**: (待填写)
- **Small mAP**: (待填写)
- **box_loss**: (待填写)
- **cls_loss**: (待填写)
- **观察**: (待填写)

#### Epoch 100

- **时间**: (待填写)
- **mAP@0.5**: (待填写)
- **Small mAP**: (待填写)
- **趋势**: (待填写)

#### Epoch 150

- **时间**: (待填写)
- **mAP@0.5**: (待填写)
- **Small mAP**: (待填写)
- **趋势**: (待填写)

#### Epoch 200

- **时间**: (待填写)
- **mAP@0.5**: (待填写)
- **Small mAP**: (待填写)
- **趋势**: (待填写)

#### Epoch 250

- **时间**: (待填写)
- **mAP@0.5**: (待填写)
- **Small mAP**: (待填写)
- **趋势**: (待填写)

#### Epoch 300 (最终)

- **完成时间**: (待填写)
- **最佳 Epoch**: (待填写)
- **最佳mAP@0.5**: (待填写)
- **最佳 Small mAP**: (待填写)

## 📈 最终验证结果

### 完整性能指标

| 指标                | Baseline | Loss 权重改进 | 变化 | 达标?    |
| ------------------- | -------- | ------------- | ---- | -------- |
| **Overall mAP@0.5** | ~41%     | (待填写)      | ?    | 目标>42% |
| **Small mAP**       | 30.94%   | (待填写)      | ?    | 目标>33% |
| **Medium mAP**      | 46.24%   | (待填写)      | ?    | -        |
| **Large mAP**       | 36.70%   | (待填写)      | ?    | -        |
| **Precision**       | ?        | (待填写)      | ?    | -        |
| **Recall**          | ?        | (待填写)      | ?    | -        |
| **FPS (RTX 4090)**  | ~35      | (待填写)      | ?    | 保持>30  |
| **参数量**          | 2.70M    | 2.70M         | 0    | 不变     |
| **FLOPs**           | 11.95G   | 11.95G        | 0    | 不变     |

### 尺寸分级详细结果

| 类别            | Small mAP | Medium mAP | Large mAP |
| --------------- | --------- | ---------- | --------- |
| pedestrian      | (待填写)  | (待填写)   | (待填写)  |
| people          | (待填写)  | (待填写)   | (待填写)  |
| bicycle         | (待填写)  | (待填写)   | (待填写)  |
| car             | (待填写)  | (待填写)   | (待填写)  |
| van             | (待填写)  | (待填写)   | (待填写)  |
| truck           | (待填写)  | (待填写)   | (待填写)  |
| tricycle        | (待填写)  | (待填写)   | (待填写)  |
| awning-tricycle | (待填写)  | (待填写)   | (待填写)  |
| bus             | (待填写)  | (待填写)   | (待填写)  |
| motor           | (待填写)  | (待填写)   | (待填写)  |

## 💡 实验分析

### 效果验证 (待填写)

**Small 目标改进**:

- Small mAP 提升: (待填写)
- 是否达到预期(+2-3%): (待填写)
- 主要提升的类别: (待填写)
- 主要原因分析: (待填写)

**Overall 性能**:

- Overall mAP 提升: (待填写)
- 是否达到目标(>42%): (待填写)
- 副作用(Medium/Large 是否下降): (待填写)

**训练稳定性**:

- Loss 收敛情况: (待填写)
- 是否出现过拟合: (待填写)
- 最佳 epoch 位置: (待填写)

### 意外发现 (如果有)

(待填写)

### 问题与不足

(待填写)

## 🔍 可视化分析

### 训练曲线

- 📊 Loss 曲线: `runs/train/exp_loss_weighted_v1/results.png`
- 📈 mAP 曲线: (同上)
- 📉 对比图: (待生成)

### 检测结果可视化

- 🖼️ Small 目标检测示例: (待生成)
- 🖼️ 与 Baseline 对比: (待生成)
- 🖼️ 失败案例分析: (待生成)

### PR 曲线

- 📊 Overall PR curve: (待生成)
- 📊 Small objects PR curve: (待生成)

## ✅ 结论

### 是否达到预期?

- [ ] ✅ 达到预期 (Small mAP +2-3%)
- [ ] ⚠️ 部分达到 (Small mAP +1-2%)
- [ ] ❌ 未达到预期 (Small mAP <+1%)

### 下一步行动

- [ ] **如果达到预期**: 继续 FPN 注意力优化
- [ ] **如果部分达到**: 调整权重比例(如 Small×2.5)后重新训练
- [ ] **如果未达到预期**: 分析原因,可能尝试不同权重策略

### 论文撰写价值

- [ ] ✅ 可作为消融实验主要内容
- [ ] ⚠️ 可作为辅助说明
- [ ] ❌ 效果不显著,暂不写入论文

## 📝 补充说明

### 实验环境

- **操作系统**: Ubuntu 22.04
- **CUDA 版本**: (待填写)
- **PyTorch 版本**: (待填写)
- **Ultralytics 版本**: 8.3.155 (定制版)

### 数据预处理

- **Depth 生成方法**: ZoeDepth
- **Depth 归一化**: [0, 255]
- **数据增强**: Mosaic, MixUp, ColorJitter 等(默认配置)

### 其他注意事项

(待填写)

---

**实验负责人**: (待填写)  
**创建时间**: 2025 年 10 月 30 日  
**最后更新**: (待填写)  
**状态**: 🚀 训练中
