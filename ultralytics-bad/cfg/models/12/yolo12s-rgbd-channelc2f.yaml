# Ultralytics YOLO ğŸš€, AGPL-3.0 License
# YOLO12-S RGB-D ChannelC2f - Phase 3: Enhanced Medium-Scale Detection
# Created: 2025-10-28 for yoloDepth Phase 3
# Objective: Solve Medium mAP crisis (14.28% â†’ target 20%+)
# Scale: Small (è½»é‡, å¯¹æ ‡ RemDet-S)

# ================================================================================================
# Phase 3 Background
# ================================================================================================
# Problem Discovery:
#   - Medium objectså æ¯”: 45.5% (17,647ä¸ª) - æœ€å¤šï¼
#   - Medium mAP: 14.28% - æœ€ä½ï¼
#   - Medium Recall: 11.7% - ä¸¥é‡æ¼æ£€ï¼
#   - Small mAP (18.13%) å’Œ Large mAP (26.88%) éƒ½æ­£å¸¸
#
# Root Cause:
#   - P4å±‚ (stride=16, medium detection layer) ç‰¹å¾è¡¨è¾¾ä¸è¶³
#   - æ¨¡å‹åå‘Smallå’ŒLargeï¼Œå¿½ç•¥Medium
#
# Solution:
#   - åœ¨P4å±‚ä½¿ç”¨ChannelC2f (C2f + Channel Attention)
#   - å¢å¼ºä¸­ç­‰å°ºåº¦ç‰¹å¾çš„é€šé“è¡¨è¾¾èƒ½åŠ›
#
# Expected Improvement:
#   - Medium mAP: 14.28% â†’ 20-25% (+6-11%)
#   - Overall mAP: 44.03% â†’ 46-48% (+2-4%)
#
# ================================================================================================

# Model Configuration
nc: 10  # VisDrone classes

# Model compound scaling constants
scales:
  # [depth, width, max_channels]
  n: [0.50, 0.25, 1024]  # YOLO12-N (Nano)  - å¯¹æ ‡ RemDet-Tiny
  s: [0.50, 0.50, 1024]  # YOLO12-S (Small) - å¯¹æ ‡ RemDet-S
  m: [0.50, 1.00, 512]   # YOLO12-M (Medium) - å¯¹æ ‡ RemDet-M
  l: [1.00, 1.00, 512]   # YOLO12-L (Large) - å¯¹æ ‡ RemDet-L
  x: [1.00, 1.50, 512]   # YOLO12-X (XLarge) - å¯¹æ ‡ RemDet-X

# ================================================================================================
# Backbone (Phase 3 Modified)
# ================================================================================================
# Key Modification:
#   Layer 6 (P4/16): A2C2f â†’ ChannelC2f â­
#   - Only P4 layer uses ChannelC2f (medium-scale detection)
#   - P3 and P5 use standard modules

backbone:
  # [from, repeats, module, args]

  # Layer 0-1: RGB-D Input Processing
  - [-1, 1, RGBDStem, [4, 128, 3, 2, 1, 64, "gated_add", 16, True]]  # 0-P1/2
  - [-1, 1, Conv, [128, 3, 2]]  # 1-P2/4

  # Layer 2-4: P3 Path (Small detection - unchanged)
  - [-1, 2, C3k2, [256, False, 0.25]]  # 2
  - [-1, 1, Conv, [256, 3, 2]]  # 3-P3/8
  - [-1, 2, C3k2, [512, False, 0.25]]  # 4

  # Layer 5-6: P4 Path (Medium detection - â­ Phase 3 MODIFICATION)
  - [-1, 1, Conv, [512, 3, 2]]  # 5-P4/16
  
  # â­ Phase 3: Replace A2C2f with ChannelC2f
  # Args: [c2, shortcut, g, e, reduction]
  #   c1 and n are auto-inserted by parse_model()
  #   c2=512: Output channels
  #   shortcut=True: Use residual connections
  #   g=1: Groups (standard convolution)
  #   e=0.5: Expansion ratio
  #   reduction=16: Channel attention bottleneck ratio
  - [-1, 4, ChannelC2f, [512, True, 1, 0.5, 16]]  # 6-P4/16 â­ Phase 3

  # Layer 7-8: P5 Path (Large detection - unchanged)
  - [-1, 1, Conv, [1024, 3, 2]]  # 7-P5/32
  - [-1, 4, A2C2f, [1024, True, 1]]  # 8

# ================================================================================================
# Head (Unchanged from Phase 1)
# ================================================================================================
head:
  # Upsample path
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]  # 9
  - [[-1, 6], 1, Concat, [1]]  # 10 - cat backbone P4 (ChannelC2f output)
  - [-1, 2, A2C2f, [512, False, -1]]  # 11

  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]  # 12
  - [[-1, 4], 1, Concat, [1]]  # 13 - cat backbone P3
  - [-1, 2, A2C2f, [256, False, -1]]  # 14

  # Downsample path
  - [-1, 1, Conv, [256, 3, 2]]  # 15
  - [[-1, 11], 1, Concat, [1]]  # 16 - cat head P4
  - [-1, 2, A2C2f, [512, False, -1]]  # 17

  - [-1, 1, Conv, [512, 3, 2]]  # 18
  - [[-1, 8], 1, Concat, [1]]  # 19 - cat head P5
  - [-1, 2, C3k2, [1024, True]]  # 20

  # Detection heads
  - [[14, 17, 20], 1, Detect, [nc]]  # 21 - Detect(P3, P4, P5)

# ================================================================================================
# Model Summary (Expected - YOLO12-S Phase 3)
# ================================================================================================
# Parameters: ~9.5M (+1.4% vs Phase 1)
# FLOPs: ~20G (+0.5% vs Phase 1)
# Pretrained: yolo12s.pt (optional)
#
# RemDet Comparison Target:
#   - RemDet-S: See AAAI2025 paper Table 1
#   - Goal: Match or exceed RemDet performance on VisDrone
#
# Training Command:
#   python train_phase3.py \
#     --model ultralytics/cfg/models/12/yolo12s-rgbd-channelc2f.yaml \
#     --data data/visdrone-rgbd.yaml \
#     --epochs 150 \
#     --batch 16 \
#     --name phase3_channelc2f_s
#
# ================================================================================================
